<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>iAttend - Admin Schedules</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Nunito:wght@600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
/* ========== RESET & BASE ========== */
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: 'Poppins', sans-serif; background: linear-gradient(75.18deg, #FFE5B4 36.63%, #F5EEDC 92.2%); color:#212529; }

/* ========== HEADER ========== */
header {
  position: fixed; top:0; left:0; right:0; height:60px; background:#fff;
  box-shadow:0 2px 20px rgba(1,41,112,0.1); display:flex; align-items:center;
  padding-left:20px; font-family:'Nunito', sans-serif; font-weight:700;
  font-size:22px; color:#212529; z-index:1002;
}
#menu-toggle { font-size:28px; margin-right:15px; cursor:pointer; }
.header-content { width:100%; display:flex; justify-content:space-between; align-items:center; }

/* ========== SIDEBAR ========== */
.sidebar {
  position: fixed; top:0; left:0; width:240px; height:100%; background: linear-gradient(180deg, #FFEED3 0%, #FFEED3 100%);
  padding-top:60px; box-shadow:2px 0 15px rgba(1,41,112,0.08); font-family:'Poppins',sans-serif;
  transition: width 0.3s, left 0.3s; z-index:1001; overflow-y:auto; border-top-right-radius:12px;
}
.sidebar.collapsed { width:70px; overflow:hidden; }
.sidebar-section { margin-bottom:25px; padding:0 15px; }
.sidebar-section-title { font-size:11px; text-transform:uppercase; letter-spacing:1px; color:#5D5FEF; margin-bottom:10px; padding-left:10px; transition:opacity 0.3s; }
.sidebar.collapsed .sidebar-section-title { opacity:0; }
.sidebar-link { display:flex; align-items:center; gap:10px; padding:12px 15px; margin-bottom:8px; border-radius:8px; font-size:15px; font-weight:500; color:#1A237E; text-decoration:none; transition:all 0.25s ease; white-space:nowrap; }
.sidebar-link i { width:18px; text-align:center; }
.sidebar-link:hover { background:rgba(255,255,255,0.5); transform:translateX(4px); }
.sidebar-link.active { background:rgba(255,255,255,0.7); color:#4154F1; font-weight:600; box-shadow:inset 0 0 0 1px rgba(181,116,28,0.2); }
.sidebar-dropdown { display:flex; flex-direction:column; }
.dropdown-menu { display:none; flex-direction:column; padding-left:20px; }
.sidebar-dropdown.active .dropdown-menu { display:flex; }
.sidebar-dropdown .dropdown-toggle i:last-child { margin-left:auto; transition: transform 0.3s; }
.sidebar-dropdown.active .dropdown-toggle i:last-child { transform: rotate(180deg); }

/* ========== MAIN CONTENT ========== */
.main-content { margin-left:260px; padding:100px 30px 30px; font-family:'Nunito',sans-serif; transition:margin-left 0.3s ease; }
.sidebar.collapsed ~ .main-content { margin-left:80px; }

/* ========== CARDS, FORMS, TABLES ========== */
.card{ background:#fff; padding:1.5rem; border-radius:12px; box-shadow:0 6px 16px rgba(0,0,0,0.08); margin-bottom:20px; }
.tabs { display:flex; gap:15px; margin-bottom:20px; }
.tab { padding:10px 18px; border-radius:8px; background:#eee; cursor:pointer; font-weight:600; transition:0.3s; }
.tab.active { background:#4154F1; color:#fff; }
select, input[type="time"], input[type="text"], button {padding:8px 12px; border-radius:6px; border:1px solid #ccc; font-size:14px; margin:5px 0; transition:0.3s; width:100%; }
select:focus, input:focus { outline:none; border-color:#4154F1; }
button { background:#4154F1; color:#fff; border:none; cursor:pointer; }
button:hover { opacity:0.9; }

/* Table */
table{width:100%; border-collapse:collapse; font-size:14px;}
th, td{padding:10px; border:1px solid #ddd; text-align:left; vertical-align:middle;}
th{background:#f8f7ff; font-weight:600;}
.timetable {width:100%; border-collapse:collapse; text-align:center;}
.timetable th, .timetable td {border:1px solid #ddd; padding:12px; vertical-align:top;}
.timetable th {background:#f8f7ff;}
.class-box {background:#eaf1ff; border:1px solid #b3c6ff; border-radius:6px; padding:6px; margin:2px; font-size:13px;}

/* ========== MOBILE ========== */
@media (max-width:768px){
  .sidebar { left:-260px; }
  .sidebar.active { left:0; }
  .main-content { margin-left:0 !important; }
}

        /* ==== Breadcrumb ==== */
.breadcrumb {
    font-family:'Nunito',sans-serif;
    font-size:14px;
    font-weight:600;  /* change from 500 to 600 */
    margin-bottom:20px; /* or 30px if you want same spacing */
}
.breadcrumb .section {
    color:#989797;
}
.breadcrumb .current {
    color:#444444;
}

    .main-content h2 {
    font-family: 'Poppins', sans-serif;
    font-size: 28px;
    font-weight: 500;
    color: #444;
    margin-bottom: 10px;
  }
</style>
</head>
<body>

<header>
  <span id="menu-toggle">&#9776;</span>
  <div class="header-content">iAttend Admin</div>
</header>

<!-- ========== SIDEBAR ========== -->
<div class="sidebar">
  <div class="sidebar-section">
    <a class="sidebar-link {% if request.endpoint == 'admin_dashboard' %}active{% endif %}" href="{{ url_for('admin_dashboard') }}">
      <i class="fas fa-home"></i><span>Dashboard</span>
    </a>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-section-title">Management</div>

    <a class="sidebar-link {% if request.endpoint == 'admin_student_add' %}active{% endif %}" href="{{ url_for('admin_student_add') }}">
      <i class="fas fa-user-graduate"></i><span>Add Students</span>
    </a>

    <div class="sidebar-dropdown {% if request.endpoint in ['admin_teacher_add','admin_teacher_assign'] %}active{% endif %}">
      <a class="sidebar-link dropdown-toggle">
        <i class="fas fa-chalkboard-teacher"></i><span>Teachers</span><i class="fas fa-chevron-down"></i>
      </a>
      <div class="dropdown-menu">
        <a class="sidebar-link {% if request.endpoint == 'admin_teacher_add' %}active{% endif %}" href="{{ url_for('admin_teacher_add') }}"><span>Add Teacher</span></a>
        <a class="sidebar-link {% if request.endpoint == 'admin_teacher_assign' %}active{% endif %}" href="{{ url_for('admin_teacher_assign') }}"><span>Assign Modules</span></a>
      </div>
    </div>

    <a class="sidebar-link {% if request.endpoint == 'admin_modules' %}active{% endif %}" href="{{ url_for('admin_modules') }}">
      <i class="fas fa-book"></i><span>Modules</span>
    </a>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-section-title">System</div>
    <a class="sidebar-link {% if request.endpoint == 'admin_rooms' %}active{% endif %}" href="{{ url_for('admin_rooms') }}"><i class="fas fa-door-open"></i><span>Rooms & Cameras</span></a>
    <a class="sidebar-link {% if request.endpoint == 'admin_schedules' %}active{% endif %} active" href="{{ url_for('admin_schedules') }}"><i class="fas fa-file-upload"></i><span>Upload Schedules</span></a>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-section-title">Logs</div>
    <a class="sidebar-link {% if request.endpoint == 'admin_attendance_log' %}active{% endif %}" href="{{ url_for('admin_attendance_log') }}"><i class="fas fa-history"></i><span>Attendance Logs</span></a>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-section-title">Attendance</div>
    <a class="sidebar-link {% if request.endpoint == 'admin_summary' %}active{% endif %}" href="{{ url_for('admin_dashboard') }}"><i class="fas fa-chart-line"></i><span>Summary</span></a>
    <a class="sidebar-link" href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
  </div>
</div>

<div class="main-content">
  <!-- Page Title -->
  <h2>Upload Schedules</h2>

  <!-- Breadcrumb -->
  <div class="breadcrumb">
    <span class="section">System</span> / <span class="current">Upload Schedules</span>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" onclick="switchTab('list')">List View</div>
    <div class="tab" onclick="switchTab('timetable')">Timetable View</div>
  </div>


<!-- Add Schedule Form (Horizontal Layout) -->
<div class="card">
  <h3>Add Schedule</h3>
  <form method="POST" action="{{ url_for('admin_schedule_save') }}" style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">

<select name="fk_teacher" required style="flex:1; min-width:150px;">
  <option value="">Select Teacher</option>
  {% for t in teachers %}
    <option value="{{ t.docId }}">{{ t.firstName }} {{ t.lastName }}</option>
  {% endfor %}
</select>

<select name="fk_program" id="fk_program" required style="flex:1; min-width:150px;" disabled>
  <option value="">Select Program</option>
  {% for p in programs %}
    <option value="{{ p.docId }}">{{ p.programName }}</option>
  {% endfor %}
</select>

<select name="fk_group" id="fk_group" required style="flex:1; min-width:120px;" disabled>
  <option value="">Select Group</option>
  {% for g in groups %}
    <option value="{{ g.docId }}">{{ g.groupCode }}</option>
  {% endfor %}
</select>

<select name="fk_module" id="fk_module" required style="flex:1; min-width:150px;" disabled>
  <option value="">Select Module</option>
  {% for m in modules %}
    <option value="{{ m.docId }}">{{ m.moduleName }}</option>
  {% endfor %}
</select>

    <select name="day" required style="flex:1; min-width:100px;">
      <option value="Monday">Monday</option>
      <option value="Tuesday">Tuesday</option>
      <option value="Wednesday">Wednesday</option>
      <option value="Thursday">Thursday</option>
      <option value="Friday">Friday</option>
    </select>

    <input type="time" name="start_time" required style="flex:1; min-width:100px;">
    <input type="time" name="end_time" required style="flex:1; min-width:100px;">
    <input type="text" name="room" placeholder="Room" required style="flex:1; min-width:100px;">

    <button type="submit" style="flex:none;">Add Schedule</button>
  </form>
</div>


  <!-- CSV Upload Form -->
  <div class="card">
    <h3>Upload Schedules (CSV)</h3>
    <form method="POST" action="{{ url_for('admin_schedule_upload_csv') }}" enctype="multipart/form-data">
      <input type="file" name="file" accept=".csv" required>
      <button type="submit">Upload CSV</button>
    </form>
  </div>

<!-- List View -->
<div id="list" class="tab-content">
  <div class="card">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Teacher</th>
          <th>Program</th>
          <th>Group</th>
          <th>Module</th>
          <th>Day</th>
          <th>Start</th>
          <th>End</th>
          <th>Room</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for s in schedules %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ s.teacher_name }}</td>
          <td>{{ s.program_name }}</td>
          <td>{{ s.group_name }}</td>
          <td>{{ s.module_name }}</td>
          <td>{{ s.day }}</td>
          <td>{{ s.start_time }}</td>
          <td>{{ s.end_time }}</td>
          <td>{{ s.room }}</td>
          <td>
            <form method="POST" action="{{ url_for('admin_schedule_delete', schedule_id=s.docId) }}" style="display:inline-block;">
              <button type="submit" style="background:#ff4c4c;">Delete</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>


  <!-- Timetable View -->
  <div id="timetable" class="tab-content" style="display:none;">
    <div class="card">
      <h3>Select Teacher</h3>
      <form method="GET" action="{{ url_for('admin_schedules') }}">
        <select name="teacher_id" onchange="this.form.submit()">
          <option value="">-- Choose Teacher --</option>
          {% for t in teachers %}
            <option value="{{ t.docId }}" {% if selected_teacher and selected_teacher.docId == t.docId %}selected{% endif %}>
              {{ t.firstName }} {{ t.lastName }}
            </option>
          {% endfor %}
        </select>
      </form>

      {% if selected_teacher %}
        <table class="timetable">
          <thead>
            <tr>
              <th>Time</th>
              <th>Monday</th>
              <th>Tuesday</th>
              <th>Wednesday</th>
              <th>Thursday</th>
              <th>Friday</th>
            </tr>
          </thead>
          <tbody>
            {% set timeslots = ["08:00","10:00","12:00","14:00","16:00"] %}
            {% for t in timeslots %}
            <tr>
              <td>{{ t }}</td>
              {% for day in ["Monday","Tuesday","Wednesday","Thursday","Friday"] %}
                {% set slot = schedules 
                               | selectattr("fk_teacher","equalto",selected_teacher.docId)
                               | selectattr("day","equalto",day)
                               | selectattr("start_time","equalto",t)
                               | list %}
                <td>
                  {% for s in slot %}
                    {% set m = modules | selectattr("docId","equalto",s.fk_module) | list %}
                    {% set g = groups  | selectattr("docId","equalto",s.fk_group)  | list %}
                    <div class="class-box">
                      <strong>{{ m[0].moduleName if m else '' }}</strong><br>
                      {{ g[0].groupCode if g else '' }}<br>
                      Room {{ s.room }}
                    </div>
                  {% endfor %}
                </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p>Please select a teacher to view the timetable.</p>
      {% endif %}
    </div>
  </div>
</div>

<script>
/* Sidebar toggle */
document.getElementById('menu-toggle').addEventListener('click', () => {
  const sidebar = document.querySelector('.sidebar');
  if(window.innerWidth <= 768) sidebar.classList.toggle('active');
  else sidebar.classList.toggle('collapsed');
});

/* Dropdown toggle */
document.querySelectorAll('.dropdown-toggle').forEach(toggle => {
  toggle.addEventListener('click', e => {
    e.preventDefault();
    toggle.parentElement.classList.toggle('active');
  });
});

/* Tabs switch */
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
  document.querySelector('.tab[onclick="switchTab(\''+tab+'\')"]').classList.add('active');
  document.getElementById(tab).style.display = 'block';
}

// --- Teacher assignments mapping ---
const teacherAssignments = {{ (teacher_assignments or {}) | tojson }};
const modules = {{ (modules or []) | tojson }};
const programs = {{ programs | tojson | default('[]') }};

// Select elements
const teacherSelect = document.querySelector('select[name="fk_teacher"]');
const programSelect = document.getElementById('fk_program');
const groupSelect = document.getElementById('fk_group');
const moduleSelect = document.getElementById('fk_module');

function autofillAssignments() {
    const teacherId = teacherSelect.value;
    const assignment = teacherAssignments[teacherId];

    if (assignment) {
        // --- Program ---
        programSelect.innerHTML = '';
        if (assignment.program) {
            // Match either by docId or programName
            let prog = programs.find(p => p.docId === assignment.program);
            if (!prog) {
                prog = programs.find(p => p.programName === assignment.program);
            }

            if (prog) {
                const opt = document.createElement('option');
                opt.value = prog.docId;
                opt.textContent = prog.programName;
                opt.selected = true; // auto select
                programSelect.appendChild(opt);
                programSelect.disabled = false;
            } else {
                programSelect.innerHTML = '<option value="">Select Program</option>';
                programSelect.disabled = true;
            }
        } else {
            programSelect.innerHTML = '<option value="">Select Program</option>';
            programSelect.disabled = true;
        }

        // --- Groups ---
        groupSelect.innerHTML = '<option value="">Select Group</option>';
        if (assignment.groups && assignment.groups.length > 0) {
            assignment.groups.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g.id;
                opt.textContent = g.name;
                groupSelect.appendChild(opt);
            });
            groupSelect.disabled = false;
        } else {
            groupSelect.disabled = true;
        }

        // --- Modules ---
        moduleSelect.innerHTML = '<option value="">Select Module</option>';
        if (assignment.modules && assignment.modules.length > 0) {
            assignment.modules.forEach(m => {
                const realModule = modules.find(mod => mod.moduleName === m.name);
                if (realModule) {
                    const opt = document.createElement('option');
                    opt.value = realModule.docId;
                    opt.textContent = realModule.moduleName;
                    moduleSelect.appendChild(opt);
                }
            });
            moduleSelect.disabled = false;
        } else {
            moduleSelect.disabled = true;
        }

    } else {
        // Reset all if no teacher selected
        programSelect.innerHTML = '<option value="">Select Program</option>';
        programSelect.disabled = true;

        groupSelect.innerHTML = '<option value="">Select Group</option>';
        groupSelect.disabled = true;

        moduleSelect.innerHTML = '<option value="">Select Module</option>';
        moduleSelect.disabled = true;
    }
}

// Trigger autofill when teacher changes
teacherSelect.addEventListener('change', autofillAssignments);

// Trigger autofill on page load if a teacher is pre-selected
if (teacherSelect.value) {
    autofillAssignments();
}
</script>
</body>
</html>
