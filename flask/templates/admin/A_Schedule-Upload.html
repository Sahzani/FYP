<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>iAttend - Admin Schedules</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    /* ========== RESET & BASE ========== */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; font-family: 'Poppins', sans-serif; background: linear-gradient(180deg, #f7ecd7 0%, #f8f1e5 35%, #fbfaf7 100%); overflow-x: hidden; }

    /* ========== HEADER ========== */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: #fff;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
      display: flex;
      align-items: center;
      padding: 0 20px;
      z-index: 1000;
    }
    #menu-toggle {
      font-size: 28px;
      margin-right: 15px;
      cursor: pointer;
      transition: color 0.3s;
    }
    #menu-toggle:hover { color: #4154F1; }
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }
    .header-content a.title {
      text-decoration: none;
      color: #444;
      font-weight: 700;
      font-size: 26px;
      transition: color 0.3s;
    }
    .header-content a.title:hover { color: #4154F1; }

    header a.user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: #444;
      font-weight: 600;
      transition: all 0.2s ease;
      padding: 0;
      border-radius: 0;
      background: transparent;
      box-shadow: none;
    }
    header a.user-info:hover {
      padding: 4px 12px;
      border-radius: 12px;
      background: #f8f1e5;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    header a.user-info img {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
    }

    /* ========== SIDEBAR ========== */
    .sidebar {
      position: fixed;
      top: 60px;
      left: 0;
      width: 250px;
      height: calc(100% - 60px);
      background: #f8f1e5;
      padding: 15px 0;
      box-shadow: 2px 0 15px rgba(0, 0, 0, 0.08);
      border-top-right-radius: 12px;
      transition: all 0.3s ease;
      overflow-y: auto;
      z-index: 999;
    }
    .sidebar-section { margin-bottom: 25px; padding: 0 15px; }
    .sidebar-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #6b7280;
      margin-bottom: 10px;
      padding-left: 10px;
    }
    .sidebar-link {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 15px;
      margin-bottom: 8px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 500;
      color: #2C2C2C;
      text-decoration: none;
      transition: all 0.25s ease;
      white-space: nowrap;
    }
    .sidebar-link i { width: 18px; text-align: center; }
    .sidebar-link.active, .sidebar-link:hover {
      background: #eadbbf;
      color: #1F2937;
      font-weight: 600;
    }

    .sidebar.collapsed {
      width: 70px;
      padding: 15px 0;
      overflow: hidden;
    }
    .sidebar.collapsed .sidebar-section-title,
    .sidebar.collapsed .sidebar-link span {
      display: none;
    }

    .sidebar-dropdown .dropdown-menu {
      display: none;
      margin-left: 20px;
      margin-top: 4px;
    }
    .sidebar-dropdown.active .dropdown-menu {
      display: block;
    }
    .sidebar-dropdown .dropdown-toggle::after {
      content: "\f078";
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      margin-left: auto;
      font-size: 12px;
    }
    .sidebar-dropdown.active .dropdown-toggle::after {
      content: "\f077";
    }

    /* ========== MAIN CONTENT ========== */
    .main-content {
      margin-left: 260px;
      padding: 100px 30px 30px;
      min-height: 100vh;
      overflow-y: auto;
      transition: margin-left 0.3s ease;
      background: transparent;
    }
    .main-content.expanded {
      margin-left: 80px;
    }

    /* ========== CARDS & FORMS ========== */
    .card {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
    }

    .tabs { display: flex; gap: 15px; margin-bottom: 20px; }
    .tab {
      padding: 10px 18px;
      border-radius: 8px;
      background: #eee;
      cursor: pointer;
      font-weight: 600;
      transition: 0.3s;
    }
    .tab.active {
      background: #4154F1;
      color: #fff;
    }

    select, input[type="time"], input[type="text"], input[type="file"], button {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      margin: 5px 0;
      transition: 0.3s;
      width: 100%;
    }
    select:focus, input:focus {
      outline: none;
      border-color: #4154F1;
    }
    button {
      background: #4154F1;
      color: #fff;
      border: none;
      cursor: pointer;
      width: auto;
    }
    button:hover { opacity: 0.9; }

    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
    th {
      background: #f8f1e5;
      font-weight: 600;
      color: #2C2C2C;
    }
    tr:hover { background: #fef9f0; }

    .timetable { width: 100%; border-collapse: collapse; text-align: center; }
    .timetable th, .timetable td {
      border: 1px solid #ddd;
      padding: 12px;
      vertical-align: top;
    }
    .timetable th { background: #f8f1e5; }
    .class-box {
      background: #eaf1ff;
      border: 1px solid #b3c6ff;
      border-radius: 6px;
      padding: 6px;
      margin: 2px;
      font-size: 13px;
    }

    .breadcrumb {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #444;
    }
    .breadcrumb .section { color: #989797; }
    .breadcrumb .current { color: #444444; }

    .main-content h2 {
      font-size: 28px;
      font-weight: 500;
      color: #444;
      margin-bottom: 10px;
    }
    .main-content h3 {
      font-size: 20px;
      margin-bottom: 15px;
      color: #2C2C2C;
    }

    @media (max-width: 768px) {
      .sidebar { left: -260px; }
      .sidebar.active { left: 0; }
      .sidebar.collapsed { left: 0; width: 250px; }
      .main-content { margin-left: 0; }
      .main-content.expanded { margin-left: 0; }
    }
  </style>
</head>
<body>

<!-- Header -->
<header>
  <span id="menu-toggle">&#9776;</span>
  <div class="header-content">
    <a href="{{ url_for('admin_dashboard') }}" class="title">iAttend</a>
    {% if current_admin %}
      <a href="#" class="user-info">
        <span>{{ current_admin.firstName }} {{ current_admin.lastName }}</span>
        <img src="https://placehold.co/36x36/899BBD/ffffff?text={{ current_admin.firstName|first|upper if current_admin.firstName else 'A' }}" alt="Profile">
      </a>
    {% else %}
      <a href="#" class="user-info">
        <span>Admin</span>
        <img src="https://placehold.co/36x36/899BBD/ffffff?text=A" alt="Admin">
      </a>
    {% endif %}
  </div>
</header>

<!-- Sidebar -->
<div class="sidebar">
  <div class="sidebar-section">
    <a class="sidebar-link {% if request.endpoint == 'admin_dashboard' %}active{% endif %}" href="{{ url_for('admin_dashboard') }}">
      <i class="fas fa-home"></i><span>Dashboard</span>
    </a>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-section-title">Management</div>
    <a class="sidebar-link {% if request.endpoint == 'admin_student_add' %}active{% endif %}" href="{{ url_for('admin_student_add') }}">
      <i class="fas fa-user-graduate"></i><span>Students</span>
    </a>

    <div class="sidebar-dropdown {% if request.endpoint in ['admin_teacher_add','admin_teacher_assign'] %}active{% endif %}">
      <a class="sidebar-link dropdown-toggle" href="#" onclick="event.preventDefault();">
        <i class="fas fa-chalkboard-teacher"></i><span>Teachers</span><i class="fas fa-chevron-down"></i>
      </a>
      <div class="dropdown-menu">
        <a class="sidebar-link {% if request.endpoint == 'admin_teacher_add' %}active{% endif %}" href="{{ url_for('admin_teacher_add') }}"><span>Add Teacher</span></a>
        <a class="sidebar-link {% if request.endpoint == 'admin_teacher_assign' %}active{% endif %}" href="{{ url_for('admin_teacher_assign') }}"><span>Assign Modules</span></a>
      </div>
    </div>

    <a class="sidebar-link {% if request.endpoint == 'admin_programs' %}active{% endif %}" href="{{ url_for('admin_programs') }}">
      <i class="fas fa-layer-group"></i><span>Programs</span>
    </a>
    <a class="sidebar-link {% if request.endpoint == 'admin_groups' %}active{% endif %}" href="{{ url_for('admin_groups') }}">
      <i class="fas fa-users"></i><span>Groups</span>
    </a>
    <a class="sidebar-link {% if request.endpoint == 'admin_modules' %}active{% endif %}" href="{{ url_for('admin_modules') }}">
      <i class="fas fa-book"></i><span>Modules</span>
    </a>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-section-title">System</div>
    <a class="sidebar-link {% if request.endpoint == 'admin_schedules' %}active{% endif %}" href="{{ url_for('admin_schedules') }}">
      <i class="fas fa-file-upload"></i><span>Upload Schedules</span>
    </a>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-section-title">Logs</div>
    <a class="sidebar-link {% if request.endpoint == 'admin_attendance_log' %}active{% endif %}" href="{{ url_for('admin_attendance_log') }}">
      <i class="fas fa-history"></i><span>Attendance Logs</span>
    </a>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-section-title">Attendance</div>
    <a class="sidebar-link {% if request.endpoint == 'admin_summary' %}active{% endif %}" href="{{ url_for('admin_summary') }}">
      <i class="fas fa-chart-line"></i><span>Summary</span>
    </a>
    <a class="sidebar-link" href="{{ url_for('logout') }}">
      <i class="fas fa-sign-out-alt"></i><span>Logout</span>
    </a>
  </div>
</div>

<!-- Main Content -->
<div class="main-content">
  <h2>Upload Schedules</h2>

  <div class="breadcrumb">
    <span class="section">System</span> / <span class="current">Upload Schedules</span>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('list')">List View</div>
    <div class="tab" onclick="switchTab('timetable')">Timetable View</div>
  </div>

  <!-- Add Schedule Form -->
  <div class="card">
    <h3>Add Schedule</h3>
    <form method="POST" action="{{ url_for('admin_schedule_save') }}" style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
      <select id="fk_teacher" name="fk_teacher" required style="flex:1; min-width:150px;">
        <option value="">Select Teacher</option>
        {% for t in teachers %}
          <option value="{{ t.docId }}">{{ t.firstName }} {{ t.lastName }}</option>
        {% endfor %}
      </select>
      <input type="text" id="fk_program_name" placeholder="Program will autofill" readonly style="flex:1; min-width:150px;">
      <input type="hidden" id="fk_program" name="fk_program">
      <select name="fk_group" id="fk_group" required style="flex:1; min-width:120px;" disabled>
        <option value="">Select Group</option>
        {% for g in groups %}
          <option value="{{ g.docId }}">{{ g.groupCode }}</option>
        {% endfor %}
      </select>
      <select name="fk_module" id="fk_module" required style="flex:1; min-width:150px;" disabled>
        <option value="">Select Module</option>
        {% for m in modules %}
          <option value="{{ m.docId }}">{{ m.moduleName }}</option>
        {% endfor %}
      </select>
      <select name="day" required style="flex:1; min-width:100px;">
        <option value="Monday">Monday</option>
        <option value="Tuesday">Tuesday</option>
        <option value="Wednesday">Wednesday</option>
        <option value="Thursday">Thursday</option>
        <option value="Friday">Friday</option>
      </select>
      <input type="time" name="start_time" required style="flex:1; min-width:100px;">
      <input type="time" name="end_time" required style="flex:1; min-width:100px;">
      <input type="text" name="room" placeholder="Room" required style="flex:1; min-width:100px;">
      <button type="submit" style="flex:none;">Add Schedule</button>
    </form>
  </div>

  <!-- CSV Upload -->
  <div class="card">
    <h3>Upload Schedules (CSV)</h3>
    <form method="POST" action="{{ url_for('admin_schedule_upload_csv') }}" enctype="multipart/form-data">
      <input type="file" name="file" accept=".csv" required>
      <button type="submit">Upload CSV</button>
    </form>
    <p style="font-size:13px; color:#666; margin-top:8px;">
      CSV must have columns: <code>Teacher Name, Group, Module, Day, Start Time, End Time, Room</code>
    </p>
    <a href="#" onclick="downloadCSVTemplate(); return false;" style="font-size:13px; color:#4154F1; text-decoration:underline; display:inline-block; margin-top:8px;">
      Download CSV template
    </a>
  </div>

  <!-- List View -->
  <div id="list" class="tab-content">
    <div class="card">
      {% if schedules %}
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Teacher</th>
                <th>Program</th>
                <th>Group</th>
                <th>Module</th>
                <th>Day</th>
                <th>Start</th>
                <th>End</th>
                <th>Room</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for s in schedules %}
              <tr>
                <td>{{ loop.index }}</td>
                <td>{{ s.teacher_name }}</td>
                <td>{{ s.program_name }}</td>
                <td>{{ s.group_name }}</td>
                <td>{{ s.module_name }}</td>
                <td>{{ s.day }}</td>
                <td>{{ s.start_time }}</td>
                <td>{{ s.end_time }}</td>
                <td>{{ s.room }}</td>
                <td>
                  <form method="POST" action="{{ url_for('admin_schedule_delete', schedule_id=s.docId) }}" style="display:inline-block;">
                    <button type="submit" style="background:#ff4c4c; color:white; padding:4px 8px; border:none; border-radius:4px; font-size:12px;">Delete</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-gray-500 text-center py-4">No schedules found.</p>
      {% endif %}
    </div>
  </div>

  <!-- Timetable View -->
  <div id="timetable" class="tab-content" style="display:none;">
    <div class="card">
      <h3>Select Teacher</h3>
      <form method="GET" action="{{ url_for('admin_schedules') }}">
        <select name="teacher_id" onchange="this.form.submit()">
          <option value="">-- Choose Teacher --</option>
          {% for t in teachers %}
            <option value="{{ t.docId }}" {% if selected_teacher and selected_teacher.docId == t.docId %}selected{% endif %}>
              {{ t.firstName }} {{ t.lastName }}
            </option>
          {% endfor %}
        </select>
      </form>

      {% if selected_teacher %}
        <table class="timetable">
          <thead>
            <tr>
              <th>Time</th>
              <th>Monday</th>
              <th>Tuesday</th>
              <th>Wednesday</th>
              <th>Thursday</th>
              <th>Friday</th>
            </tr>
          </thead>
          <tbody>
            {% set timeslots = ["08:00","10:00","12:00","14:00","16:00"] %}
            {% for t in timeslots %}
            <tr>
              <td>{{ t }}</td>
              {% for day in ["Monday","Tuesday","Wednesday","Thursday","Friday"] %}
                {% set slot = schedules 
                               | selectattr("fk_teacher","equalto",selected_teacher.docId)
                               | selectattr("day","equalto",day)
                               | selectattr("start_time","equalto",t)
                               | list %}
                <td>
                  {% for s in slot %}
                    {% set m = mlmodules | selectattr("docId","equalto",s.fk_module) | list %}
                    {% set g = groups  | selectattr("docId","equalto",s.fk_group)  | list %}
                    <div class="class-box">
                      <strong>{{ m[0].moduleName if m else '' }}</strong><br>
                      {{ g[0].groupCode if g else '' }}<br>
                      Room {{ s.room }}
                    </div>
                  {% endfor %}
                </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p>Please select a teacher to view the timetable.</p>
      {% endif %}
    </div>
  </div>
</div>

<script>
// Sidebar toggle
const menuToggle = document.getElementById('menu-toggle');
const sidebar = document.querySelector('.sidebar');
menuToggle.addEventListener('click', () => {
  if (window.innerWidth <= 768) {
    sidebar.classList.toggle('active');
  } else {
    sidebar.classList.toggle('collapsed');
  }
  document.querySelector('.main-content').classList.toggle('expanded');
});

// Dropdown toggle
document.querySelectorAll('.dropdown-toggle').forEach(toggle => {
  toggle.addEventListener('click', e => {
    e.preventDefault();
    toggle.parentElement.classList.toggle('active');
  });
});

// Tab switching
function switchTab(tabName) {
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  event.target.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
  document.getElementById(tabName).style.display = 'block';
}

// Teacher assignment logic (keep as-is)
const teacherSelect = document.getElementById('fk_teacher');
const programNameInput = document.getElementById('fk_program_name');
const programHiddenInput = document.getElementById('fk_program');
const groupSelect = document.getElementById('fk_group');
const moduleSelect = document.getElementById('fk_module');

const teachers = {{ teachers | tojson | default('[]') }};
const groups = {{ groups | tojson | default('[]') }};
const modules = {{ mlmodules | tojson | default('[]') }};
const teacherAssignments = {{ teacher_assignments | tojson | default('{}') }};

function populateSelect(selectElement, options, valueField = 'id', textField = 'name') {
  const currentValue = selectElement.value;
  selectElement.innerHTML = '<option value="">Select ' + (selectElement.name.includes('group') ? 'Group' : 'Module') + '</option>';
  options.forEach(option => {
    const opt = document.createElement('option');
    opt.value = option[valueField];
    opt.textContent = option[textField];
    selectElement.appendChild(opt);
  });
  if (currentValue && options.some(opt => opt[valueField] === currentValue)) {
    selectElement.value = currentValue;
  }
}

teacherSelect?.addEventListener('change', () => {
  const teacherId = teacherSelect.value;
  programNameInput.value = '';
  programHiddenInput.value = '';
  groupSelect.value = '';
  moduleSelect.value = '';
  groupSelect.disabled = true;
  moduleSelect.disabled = true;

  if (!teacherId) return;
  const assignment = teacherAssignments[teacherId];
  if (!assignment) return;

  if (assignment.program_name) {
    programNameInput.value = assignment.program_name;
    programHiddenInput.value = assignment.program_id || '';
  }

  if (assignment.groups && assignment.groups.length > 0) {
    groupSelect.disabled = false;
    populateSelect(groupSelect, assignment.groups, 'id', 'name');
  } else {
    groupSelect.disabled = false;
    populateSelect(groupSelect, groups, 'docId', 'groupCode');
  }

  if (assignment.modules && assignment.modules.length > 0) {
    moduleSelect.disabled = false;
    populateSelect(moduleSelect, assignment.modules, 'id', 'name');
  } else {
    moduleSelect.disabled = false;
    populateSelect(moduleSelect, modules, 'docId', 'moduleName');
  }
});

// CSV Template Download
function downloadCSVTemplate() {
  const template = `Teacher Name,Group,Module,Day,Start Time,End Time,Room
John Smith,CS101,Web Development,Monday,09:00,10:30,A101
`;
  const blob = new Blob([template], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'schedules_template.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
</script>

</body>
</html>