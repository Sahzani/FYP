<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>iAttend Admin - Groups & Programs</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Nunito:wght@600;700&display=swap" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
<style>
/* ====== BASE ====== */
body {
  font-family:'Poppins',sans-serif;
  background: linear-gradient(75.18deg,#FFE5B4 36.63%,#F5EEDC 92.2%);
  margin:0;
  padding:0;
}

/* ====== SIDEBAR ====== */
.sidebar {
  position: fixed;
  top: 0;
  left: 0;
  width: 240px;
  height: 100%;
  background: linear-gradient(180deg, #FFEED3 0%, #FFEED3 100%);
  padding-top: 60px;
  box-shadow: 2px 0 15px rgba(1,41,112,0.08);
  overflow-y: auto;
  border-top-right-radius: 12px;
  transition: 0.3s;
}
.sidebar.collapsed { width: 70px; overflow:hidden; }
.sidebar-section { margin-bottom: 25px; padding:0 15px; }
.sidebar-section-title { font-size:11px; text-transform:uppercase; letter-spacing:1px; color:#5D5FEF; margin-bottom:10px; padding-left:10px; }
.sidebar-link { display:flex; align-items:center; gap:10px; padding:12px 15px; margin-bottom:8px; border-radius:8px; font-size:15px; font-weight:500; color:#1A237E; text-decoration:none; transition:0.25s; }
.sidebar-link i { width:18px; text-align:center; }
.sidebar-link:hover { background: rgba(255,255,255,0.5); transform: translateX(3px); }
.sidebar-link.active { background: rgba(255,255,255,0.7); color:#4154F1; font-weight:600; box-shadow: inset 0 0 0 1px rgba(181,116,28,0.2); }

/* Dropdown */
.sidebar-dropdown { display:flex; flex-direction:column; }
.dropdown-menu { display:none; flex-direction:column; padding-left:20px; }
.sidebar-dropdown.active .dropdown-menu { display:flex; }
.sidebar-dropdown .dropdown-toggle i { margin-left:auto; transition: transform 0.3s; }
.sidebar-dropdown.active .dropdown-toggle i { transform: rotate(180deg); }

/* ====== MAIN CONTENT ====== */
.main-content {
  margin-left: 260px;
  padding: 80px 20px 40px 20px;
  transition: 0.3s;
}
.sidebar.collapsed ~ .main-content { margin-left: 80px; }

.card {
  background:#fff;
  border-radius:12px;
  box-shadow:0 8px 20px rgba(0,0,0,0.08);
  padding:30px;
  max-width:700px;
  margin:auto;
}
.card h2 {
  color:#012970;
  margin-bottom:20px;
  font-weight:700;
  text-align:center;
}

/* Form Styles */
label { display:block; margin-bottom:6px; font-weight:600; color:#012970; }
input, button, select { width:100%; padding:12px; border-radius:8px; border:1px solid #ccc; font-size:14px; margin-bottom:15px; }
input:focus, select:focus { outline:none; border-color:#1e90ff; box-shadow:0 0 5px rgba(30,144,255,0.3); }

button {
  background: linear-gradient(90deg,#1e90ff 0%,#0066ff 100%);
  color:white;
  font-weight:600;
  border:none;
  cursor:pointer;
  transition:0.25s;
}
button:hover { opacity:0.9; transform: translateY(-1px); }

/* Responsive */
@media(max-width:768px){
  .main-content{margin-left:0;padding:80px 10px;}
  .sidebar{left:-260px;}
  .sidebar.show{left:0;}
}
</style>
</head>
<body>

<!-- ====== SIDEBAR ====== -->
<div class="sidebar">
  <div class="sidebar-section">
    <a class="sidebar-link" href="{{ url_for('admin_dashboard') }}"><i class="fas fa-home"></i><span>Dashboard</span></a>
  </div>
  <div class="sidebar-section">
    <div class="sidebar-section-title">Management</div>
    <a class="sidebar-link active" href="{{ url_for('admin_modules') }}"><i class="fas fa-book"></i><span>Modules</span></a>

    <div class="sidebar-dropdown">
      <a class="sidebar-link dropdown-toggle"><i class="fas fa-user-graduate"></i><span>Students</span><i class="fas fa-chevron-down"></i></a>
      <div class="dropdown-menu">
        <a class="sidebar-link" href="{{ url_for('admin_student_list') }}">All Students</a>
        <a class="sidebar-link" href="{{ url_for('admin_student_add') }}">Add Student</a>
        <a class="sidebar-link" href="{{ url_for('admin_student_assign') }}">Assign Modules / Groups</a>
      </div>
    </div>

    <div class="sidebar-dropdown">
      <a class="sidebar-link dropdown-toggle"><i class="fas fa-chalkboard-teacher"></i><span>Teachers</span><i class="fas fa-chevron-down"></i></a>
      <div class="dropdown-menu">
        <a class="sidebar-link" href="{{ url_for('admin_teacher_list') }}">All Teachers</a>
        <a class="sidebar-link" href="{{ url_for('admin_teacher_add') }}">Add Teacher</a>
        <a class="sidebar-link" href="{{ url_for('admin_teacher_assign') }}">Assign Modules / Rooms</a>
      </div>
    </div>
  </div>
</div>

<!-- ====== MAIN CONTENT ====== -->
<div class="main-content">
  <div class="card">
    <h2>Add Group</h2>
    <form id="groupForm">
      <label>Group Code</label>
      <input type="text" id="groupCode" placeholder="e.g. G01" required>

      <label>Program</label>
      <input type="text" id="programName" placeholder="Type program name or upload CSV" required>

      <label>Intake</label>
      <input type="text" id="intake" placeholder="e.g. Jan2025" required>

      <label>Upload Groups CSV</label>
      <input type="file" id="groupCsv" accept=".csv">

      <button type="submit">Add Group</button>
    </form>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, addDoc, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC_pq3Gnzwkdvc9CPeRa3Yre_vkcijzVpk",
  authDomain: "aimanzamani.firebaseapp.com",
  projectId: "aimanzamani",
  storageBucket: "aimanzamani.appspot.com",
  messagingSenderId: "63348630728",
  appId: "1:63348630728:web:5d1537bd1c6e14535171fd"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ✅ Ensure program exists (use program name as ID)
async function ensureProgram(name){
  const cleanName = name.trim().toLowerCase();
  const programRef = doc(db, "programs", cleanName);
  const snapshot = await getDoc(programRef);

  if (!snapshot.exists()) {
    await setDoc(programRef, { program_name: cleanName });
  }

  return programRef.id;
}

// ✅ Add Group manually
document.getElementById('groupForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const groupCode = document.getElementById('groupCode').value.trim();
  const programName = document.getElementById('programName').value.trim();
  const intake = document.getElementById('intake').value.trim();

  if(!groupCode || !programName || !intake) return alert("Please fill all fields");

  try{
    const programId = await ensureProgram(programName);
    await addDoc(collection(db,"groups"),{
      group_code: groupCode,
      fk_program: programId,
      intake: intake
    });
    alert("Group added successfully!");
    document.getElementById('groupForm').reset();
  }catch(err){
    alert("Failed: "+err.message);
  }
});

// ✅ CSV upload
document.getElementById('groupCsv').addEventListener('change', async e=>{
  const file = e.target.files[0];
  if(!file) return;
  const text = await file.text();
  const rows = text.split('\n').filter(r=>r.trim());

  for(const row of rows){
    const [groupCode, programName, intake] = row.split(',');
    if(groupCode && programName && intake){
      const programId = await ensureProgram(programName);
      await addDoc(collection(db,"groups"),{
        group_code: groupCode.trim(),
        fk_program: programId,
        intake: intake.trim()
      });
    }
  }
  alert("Groups CSV uploaded!");
  e.target.value = '';
});
</script>
</body>
</html>
