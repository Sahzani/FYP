<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>iAttend - Assign Modules to Teachers</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;font-family:'Poppins',sans-serif;background:linear-gradient(75.18deg,#FFE5B4 36.63%,#F5EEDC 92.2%);}
header{position:fixed;top:0;left:0;right:0;height:60px;background:#fff;box-shadow:0 2px 20px rgba(1,41,112,0.1);display:flex;align-items:center;padding:0 20px;font-family:'Nunito',sans-serif;font-weight:700;font-size:26px;color:#212529;z-index:1002;}
#menu-toggle{font-size:28px;margin-right:15px;cursor:pointer;}
.header-content{width:100%;display:flex;justify-content:space-between;align-items:center;}
.user-info{display:flex;align-items:center;gap:15px;padding:0 20px;border-radius:8px;cursor:pointer;}
.user-info img{width:36px;height:36px;border-radius:50%;object-fit:cover;}
.user-info span{font-size:16px;font-weight:600;color:#444;}
.sidebar{position:fixed;top:0;left:0;width:240px;height:100%;background:linear-gradient(180deg,#FFEED3 0%,#FFEED3 100%);padding-top:60px;font-family:'Poppins',sans-serif;transition: width 0.4s ease;z-index:1001;overflow-y:auto;box-shadow:2px 0 15px rgba(1,41,112,0.08);border-radius:0 16px 16px 0;}
.sidebar.collapsed{width:70px;}
.sidebar-section{margin-bottom:25px;}
.sidebar-link{display:flex;align-items:center;gap:12px;padding:12px 20px;margin-bottom:5px;border-radius:8px;font-size:15px;font-weight:500;color:#1A237E;text-decoration:none;white-space:nowrap;}
.sidebar-link.active{background:rgba(255,255,255,0.7);color:#4154F1;font-weight:600;}
.main-content{margin-left:260px;padding:100px 30px 30px;height:100vh;overflow-y:auto;transition:margin-left 0.4s;}
.sidebar.collapsed ~ .main-content{margin-left:80px;}
.card{background:#fff;padding:1.5rem;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,0.08);margin-bottom:20px;}
table{width:100%;border-collapse:collapse;font-family:'Poppins',sans-serif;font-size:14px;}
th{background-color:#f8f7ff;text-align:left;padding:12px;font-weight:500;}
td{padding:12px;border-top:1px solid #ddd;}
select,input{padding:6px;border-radius:6px;border:1px solid #ccc;font-size:14px;}
button.action-btn{padding:5px 10px;border:none;border-radius:5px;cursor:pointer;margin-right:5px;color:white;}
button.save-btn{background:#1e90ff;}
</style>
</head>
<body>

<header>
  <span id="menu-toggle">&#9776;</span>
  <div class="header-content">
    <span>iAttend Admin</span>
    <div class="user-info">
      <span>Admin</span>
      <img src="https://placehold.co/36x36/899BBD/ffffff?text=A" alt="Admin Profile">
    </div>
  </div>
</header>

<div class="sidebar">
  <div class="sidebar-section">
    <a class="sidebar-link" href="#"><i class="fas fa-home"></i><span>Dashboard</span></a>
  </div>
  <div class="sidebar-section">
    <a class="sidebar-link active" href="#"><i class="fas fa-chalkboard-teacher"></i><span>Assign Modules</span></a>
  </div>
</div>

<div class="main-content">
  <h2>Assign Modules to Teachers</h2>
  <div class="card">
    <table>
      <thead>
        <tr>
          <th>Teacher Name</th>
          <th>Email</th>
          <th>Program</th>
          <th>Group Code</th>
          <th>Assign Module</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="teacherTable">
        <!-- JS will populate this -->
      </tbody>
    </table>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC_pq3Gnzwkdvc9CPeRa3Yre_vkcijzVpk",
  authDomain: "aimanzamani.firebaseapp.com",
  projectId: "aimanzamani",
  storageBucket: "aimanzamani.appspot.com",
  messagingSenderId: "63348630728",
  appId: "1:63348630728:web:5d1537bd1c6e14535171fd"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

async function loadTeachers() {
  const tbody = document.getElementById('teacherTable');
  tbody.innerHTML = '';

  const usersSnap = await getDocs(collection(db,'users'));
  for(const userDoc of usersSnap.docs){
    const userData = userDoc.data();
    if(userData.role_type === 2){ // teacher
      let groupId='', programName='', groupCode='';
      const rolesSnap = await getDocs(collection(db,'users',userDoc.id,'roles'));
      rolesSnap.forEach(r => { if(r.id==='teacher'){ groupId = r.data().fk_groupcode || ''; } });
      if(groupId){
        const groupDoc = await getDoc(doc(db,'groups',groupId));
        if(groupDoc.exists()){
          programName = groupDoc.data().fk_program || '';
          groupCode = groupDoc.data().group_code || '';
        }
      }

      // Fetch modules for the teacher's program
      let moduleOptions = '';
      const modulesSnap = await getDocs(collection(db,'modules'));
      modulesSnap.forEach(mod => {
        const m = mod.data();
        if(m.fk_program === programName){ // only modules in same program
          moduleOptions += `<option value="${mod.id}">${m.moduleName} (${m.moduleCode})</option>`;
        }
      });

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${userData.name}</td>
        <td>${userData.email}</td>
        <td>${programName}</td>
        <td>${groupCode}</td>
        <td>
          <select class="module-select">${moduleOptions}</select>
        </td>
        <td>
          <button class="action-btn save-btn">Save</button>
        </td>
      `;
      tbody.appendChild(tr);

      // Save button
      tr.querySelector('.save-btn').addEventListener('click', async () => {
        const moduleId = tr.querySelector('.module-select').value;
        if(!moduleId) return alert('Select a module first!');
        try{
          await setDoc(doc(db,'teacher_modules',userDoc.id),{
            teacherId: userDoc.id,
            moduleId: moduleId,
            groupId: groupId
          });
          alert('✅ Module assigned successfully!');
        } catch(err){
          alert('❌ Error: '+err.message);
        }
      });
    }
  }
}

loadTeachers();
</script>

</body>
</html>
