<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>iAttend - My Modules & Groups</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Nunito:wght@600;700&display=swap" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
<!-- Include Flatpickr CSS & JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Poppins',sans-serif; background: linear-gradient(75.18deg, #FFE5B4 36.63%, #F5EEDC 92.2%); }
header { position: fixed; top:0; left:0; right:0; height:60px; background:#fff; box-shadow:0 2px 20px rgba(1,41,112,0.1); display:flex; align-items:center; padding-left:20px; font-family:'Nunito',sans-serif; font-weight:700; font-size:26px; color:#212529; z-index:1000; }
#menu-toggle { font-size:28px; margin-right:15px; cursor:pointer; }
.header-content { width:100%; display:flex; justify-content:space-between; align-items:center; }
.user-info { display:flex; align-items:center; gap:15px; padding:0 20px; border-radius:8px; transition:0.2s; cursor:pointer; text-decoration: none; }
.user-info:hover { background:#f0f0f0; }
.user-info img { width:36px; height:36px; border-radius:50%; object-fit:cover; }
.user-info span { font-size:16px; font-weight:600; color:#444; }
.breadcrumb { font-family:'Nunito',sans-serif; font-size:14px; font-weight:600; margin-top:4px; }
.breadcrumb .section { color:#989797; }
.breadcrumb .current { color:#444444; }

/* Sidebar */
.sidebar { position: fixed; top:60px; left:0; width:267px; height: calc(100% - 60px); background: linear-gradient(180deg, #FFEED3 0%, #FFEED3 100%); padding:15px 0; box-shadow:2px 0 15px rgba(1,41,112,0.08); transition: width 0.3s ease; z-index:999; border-top-right-radius:12px; overflow:hidden;}
.sidebar.collapsed { width:70px; }
.sidebar-section { margin-bottom:25px; padding:0 15px; }
.sidebar-section-title { font-size:11px; text-transform:uppercase; letter-spacing:1px; color:#5D5FEF; margin-bottom:10px; padding-left:10px; transition:opacity 0.3s; }
.sidebar.collapsed .sidebar-section-title { opacity:0; }
.sidebar-link { display:flex; align-items:center; gap:10px; padding:12px 15px; margin-bottom:8px; border-radius:8px; font-size:15px; font-weight:500; color:#1A237E; text-decoration:none; transition:all 0.25s ease; white-space:nowrap; }
.sidebar.collapsed .sidebar-link span { display:none; }
.sidebar-link i { width:18px; text-align:center; }
.sidebar-link:hover { background: rgba(255,255,255,0.5); transform: translateX(4px);}
.sidebar-link.active { background: rgba(255,255,255,0.7); color:#4154F1; font-weight:600; }

/* Main */
.main { margin-left:260px; padding:100px 30px 30px; min-height:100vh; transition:margin-left 0.3s ease;}
.sidebar.collapsed ~ .main { margin-left:80px; }

/* Table compact styles */
table { width:100%; border-collapse:collapse; }
thead { position: sticky; top:0; background:#f1f3f6; z-index:10; }
table th, table td { padding:8px 12px; font-size:14px; border-radius:4px; text-align:left; }
tr:hover { background:#f9f9f9; }
td.status-Present { color: green; font-weight: 600; }
td.status-Absent { color: red; font-weight: 600; }
td.status-Late { color: orange; font-weight: 600; }
td.status-NotMarked { color: gray; font-weight: 600; }
.edit-btn { cursor:pointer; font-size:12px; padding:4px 8px; border-radius:6px; transition:0.2s; }
.edit-btn:hover { transform:scale(1.05); }
h2.module-title { font-size:22px; font-weight:700; margin-bottom:16px; }

/* Scrollable table container */
.table-scroll { overflow-x:auto; }

/* Attendance summary cards */
.summary-card {
  background: #fff;
  padding: 1rem;
  border-radius: 1rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}
.summary-card i { font-size:1.25rem; }
.summary-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:1rem; margin-bottom:1.5rem; }

/* Modal */
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:10000; }
.modal-content { background:#fff; padding:20px 25px; border-radius:12px; width:320px; text-align:center; transform:translateY(-50px); transition:transform 0.3s ease; }
.modal.show { display:flex; }
.modal-content.show { transform:translateY(0); }
.modal button { margin:5px; padding:6px 12px; border:none; border-radius:8px; font-weight:600; cursor:pointer; }
.btn-save { background:#4154F1; color:#fff; }
.btn-cancel { background:#ccc; color:#000; }
.btn-reset { background:#f87171; color:#fff; }

/* Attendance notifications */
.notification { background:#fff3cd; color:#856404; padding:10px 15px; border:1px solid #ffeeba; border-radius:8px; margin-bottom:10px; font-size:14px; }
.filter-container { margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-end; }
.input-group { position: relative; }
.input-group i { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #888; pointer-events: none; }
.filter-container input, .filter-container select { padding: 8px 12px; padding-left: 32px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; outline: none; }
.filter-container input:focus, .filter-container select:focus { border-color: #5D5FEF; box-shadow: 0 0 0 2px rgba(93, 95, 239, 0.2); }
</style>
</head>
<body>

<header>
  <span id="menu-toggle">&#9776;</span>
  <div class="header-content">
    <a href="#" style="text-decoration:none;color:inherit;">iAttend</a>
    <a href="#" class="user-info">
      <span>{{ profile.firstName }} {{ profile.lastName }}</span>
      <img src="https://placehold.co/40x40/b8c6ff/ffffff?text=T" alt="Teacher">
    </a>
  </div>
</header>

<div class="sidebar">
  <div class="sidebar-section">
    <a class="sidebar-link" href="{{ url_for('teacher_dashboard') }}"><i class="fas fa-home"></i><span>Dashboard</span></a>
  </div>
  <div class="sidebar-section">
    <div class="sidebar-section-title">Reports</div>
    <a class="sidebar-link" href="{{ url_for('teacher_attendance') }}"><i class="fas fa-chart-bar"></i><span>Attendance Report</span></a>
  </div>
  <div class="sidebar-section">
    <div class="sidebar-section-title">Manage</div>
    <a class="sidebar-link" href="{{ url_for('teacher_schedules') }}"><i class="fas fa-calendar"></i><span>Class Schedule</span></a>
    <a class="sidebar-link active" href="{{ url_for('teacher_modules') }}"><i class="fas fa-book"></i><span>My Modules & Groups</span></a>
    <a class="sidebar-link" href="{{ url_for('teacher_manage_absent') }}"><i class="fas fa-calendar-alt"></i><span>Absences Application</span></a>
  </div>
</div>

<!-- Main Content -->
<div class="main">
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-2xl font-bold">My Modules</h1>
      <div class="breadcrumb"><span class="section">Manage</span> / <span class="current">My Modules & Groups</span></div>
    </div>
  </div>

  <!-- Modules Grid -->
  <div id="modulesContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>

  <!-- Module Details -->
  <div id="moduleDetails" class="hidden">
    <button id="backBtn" class="mb-4 px-3 py-1 bg-gray-300 rounded hover:bg-gray-400">‚Üê Back</button>
    <h2 id="moduleTitle" class="module-title mb-4"></h2>
    <div id="groupsContainer" class="flex flex-col gap-6"></div>
  </div>

  <!-- Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <h3>Edit Attendance</h3>
      <p id="modalStudent"></p>
      <select id="statusSelect" class="mb-4 w-full border border-gray-300 rounded px-2 py-1">
        <option value="Present">Present</option>
        <option value="Absent">Absent</option>
        <option value="Late">Late</option>
        <option value="Not Marked">Not Marked</option>
      </select>
      <div>
        <button class="btn-save">Save</button>
        <button class="btn-reset">Reset</button>
        <button class="btn-cancel">Cancel</button>
      </div>
    </div>
  </div>

</div>

<script>
const modulesData = {{ modules_data|tojson }};
const groupsData = {{ groups_data|tojson }};
const selectedDate = "{{ selected_date or '' }}";

const modulesContainer = document.getElementById('modulesContainer');
const moduleDetailsDiv = document.getElementById('moduleDetails');
const moduleTitle = document.getElementById('moduleTitle');
const groupsContainer = document.getElementById('groupsContainer');
const backBtn = document.getElementById('backBtn');

const modal = document.getElementById('editModal');
const modalStudent = document.getElementById('modalStudent');
const statusSelect = document.getElementById('statusSelect');
let currentEdit = { groupCode:null, student:null, dateValue:null };

// --- Render Modules ---
function renderModules() {
  modulesContainer.innerHTML = '';
  modulesData.forEach(m => {
    const card = document.createElement('div');
    card.className = 'bg-white p-6 rounded-2xl shadow hover:shadow-lg transition cursor-pointer';
    card.innerHTML = `
      <div class="flex items-center mb-3">
        <div class="w-12 h-12 flex items-center justify-center rounded-xl bg-indigo-100 text-indigo-600 mr-3">
          <i class="fas fa-book text-xl"></i>
        </div>
        <h2 class="text-lg font-semibold">${m.moduleName}</h2>
      </div>
      <p class="text-sm text-gray-500">${m.groups.length} group(s)</p>
    `;
    card.addEventListener('click', () => showModuleDetails(m));
    modulesContainer.appendChild(card);
  });
}

// --- Show Module Details ---
function showModuleDetails(module) {
  modulesContainer.classList.add('hidden');
  moduleDetailsDiv.classList.remove('hidden');
  moduleTitle.textContent = module.moduleName;
  renderGroups(module.groups);
}

// --- Render Groups ---
function renderGroups(groupCodes) {
  groupsContainer.innerHTML = '';
  groupCodes.forEach(code => {
    const g = groupsData[code];
    if(!g) return;

    const groupCard = document.createElement('div');
    groupCard.className = 'bg-white p-4 rounded-2xl shadow hover:shadow-lg transition cursor-pointer group-card';
    groupCard.style.maxWidth = '400px';
    groupCard.innerHTML = `
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 flex items-center justify-center rounded-xl bg-indigo-100 text-indigo-600 flex-shrink-0">
          <i class="fas fa-users text-xl"></i>
        </div>
        <div class="flex-1">
          <h3 class="text-lg font-semibold mb-1">${g.groupName}</h3>
          <p class="text-sm text-gray-500 mb-2">${g.day} ${g.time} | Room: ${g.room}</p>
          <p class="text-sm text-gray-500 mb-0">${g.students.length} student(s)</p>
        </div>
      </div>
    `;
    groupCard.addEventListener('click', () => showStudentAttendance(code));
    groupsContainer.appendChild(groupCard);
  });
}

// --- Show Student Attendance ---
function showStudentAttendance(groupCode) {
  const g = groupsData[groupCode];
  groupsContainer.innerHTML = '';
  moduleTitle.textContent = `${g.groupName} - ${g.day} ${g.time} (${g.room})`;

  // Filters
  const filterDiv = document.createElement('div');
  filterDiv.className = 'filter-container mb-4';
  filterDiv.innerHTML = `
    <div class="input-group mb-2">
      <i class="fas fa-search"></i>
      <input id="searchInput" placeholder="Search student...">
    </div>
    <div class="flex gap-2 mb-4">
      <input type="text" id="dateFilter" placeholder="Select Date (YYYY-MM-DD)">
      <select id="statusFilter" class="ml-2">
        <option value="">All Status</option>
        <option value="Present">Present</option>
        <option value="Absent">Absent</option>
        <option value="Late">Late</option>
        <option value="Not Marked">Not Marked</option>
      </select>
    </div>
  `;
  groupsContainer.appendChild(filterDiv);

  // Flatpickr with YYYY-MM-DD
  const fp = flatpickr("#dateFilter", {
    dateFormat: "Y-m-d",
    defaultDate: selectedDate || new Date(),
    onChange: function(selectedDates, dateStr) {
      renderTable(dateStr);
    }
  });

  function renderTable(dateValue) {
    const oldTable = document.getElementById('attendanceTable');
    if(oldTable) oldTable.remove();
    const oldSummary = document.getElementById('summaryDiv');
    if(oldSummary) oldSummary.remove();
    const oldNotif = document.getElementById('notifDiv');
    if(oldNotif) oldNotif.remove();

    const notifDiv = document.createElement('div');
    notifDiv.id = 'notifDiv';
    if(!g.students.length){
      notifDiv.className='notification';
      notifDiv.textContent='No students found in this group.';
      groupsContainer.appendChild(notifDiv);
    }

    // --- Summary ---
    const summaryDiv = document.createElement('div');
    summaryDiv.className = 'summary-grid mb-4';
    summaryDiv.id = 'summaryDiv';
    const statusCounts = { Present:0, Absent:0, Late:0, "Not Marked":0 };

    g.students.forEach(s => {
      let att = s.attendance.find(a => a.date === dateValue);
      if(!att){
        att = { date: dateValue, status: "Not Marked", timestamp: null };
        s.attendance.push(att);
      }
      s.currentStatus = att.status;
      if(statusCounts[s.currentStatus] !== undefined) statusCounts[s.currentStatus]++;
    });

    const icons = { Present:'fa-check-circle', Absent:'fa-times-circle', Late:'fa-clock', "Not Marked":'fa-question-circle' };
    Object.keys(statusCounts).forEach(status => {
      const card = document.createElement('div');
      card.className = 'summary-card p-4 rounded-2xl shadow flex flex-col items-center justify-center';
      card.innerHTML = `
        <div class="w-12 h-12 flex items-center justify-center rounded-full bg-indigo-100 text-indigo-600 mb-2">
          <i class="fas ${icons[status]}"></i>
        </div>
        <p class="text-sm font-semibold">${status}</p>
        <p class="text-lg font-bold">${statusCounts[status]}</p>
      `;
      summaryDiv.appendChild(card);
    });
    groupsContainer.appendChild(summaryDiv);

    // --- Table ---
    const tableWrapper = document.createElement('div');
    tableWrapper.className='bg-white p-4 rounded-2xl shadow overflow-x-auto table-scroll w-full';
    tableWrapper.id='attendanceTable';
    tableWrapper.innerHTML = `
      <table class="w-full text-sm">
        <thead>
          <tr class="bg-gray-100"><th>Name</th><th>Status</th><th>Action</th></tr>
        </thead>
        <tbody>
          ${g.students.map(s=>`
            <tr class="border-b hover:bg-gray-50">
              <td>${s.name}</td>
              <td class="status-${s.currentStatus.replace(' ','')}">${s.currentStatus}</td>
              <td>
                <button class="edit-btn bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600" data-student="${s.name}">Edit</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
    groupsContainer.appendChild(tableWrapper);

    // --- Edit buttons ---
    tableWrapper.querySelectorAll('.edit-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const student = btn.dataset.student;
        currentEdit={groupCode, student, dateValue};
        modalStudent.textContent = student;
        const s = g.students.find(st=>st.name===student);
        const att = s.attendance.find(a=>a.date===dateValue);
        statusSelect.value = att.status;
        modal.classList.add('show');
        document.querySelector('.modal-content').classList.add('show');
      });
    });

    // --- Filters ---
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    function applyFilters(){
      const search = searchInput.value.toLowerCase();
      const filter = statusFilter.value;
      tableWrapper.querySelectorAll('tbody tr').forEach(tr=>{
        const name = tr.querySelector('td:first-child').textContent.toLowerCase();
        const status = tr.querySelector('td:nth-child(2)').textContent;
        tr.style.display = (name.includes(search) && (!filter || status===filter)) ? '' : 'none';
      });
    }
    searchInput.addEventListener('input', applyFilters);
    statusFilter.addEventListener('change', applyFilters);
  }

  renderTable(fp.input.value);
}

// --- Modal actions ---
document.querySelector('.btn-cancel').addEventListener('click',()=>{
  modal.classList.remove('show');
  document.querySelector('.modal-content').classList.remove('show');
});
document.querySelector('.btn-save').addEventListener('click',()=>{
  const {groupCode, student, dateValue} = currentEdit;
  const s = groupsData[groupCode].students.find(st=>st.name===student);
  if(s){
    const attIndex = s.attendance.findIndex(a=>a.date===dateValue);
    if(attIndex>=0){
      s.attendance[attIndex].status = statusSelect.value;
    } else {
      s.attendance.push({ date: dateValue, status: statusSelect.value, timestamp: new Date().toISOString() });
    }
  }
  showStudentAttendance(groupCode);
  modal.classList.remove('show');
  document.querySelector('.modal-content').classList.remove('show');
});
document.querySelector('.btn-reset').addEventListener('click',()=>{
  const {groupCode, student, dateValue} = currentEdit;
  const s = groupsData[groupCode].students.find(st=>st.name===student);
  if(s){
    const attIndex = s.attendance.findIndex(a=>a.date===dateValue);
    if(attIndex>=0){
      s.attendance[attIndex].status = "Not Marked";
    } else {
      s.attendance.push({ date: dateValue, status: "Not Marked", timestamp: new Date().toISOString() });
    }
  }
  showStudentAttendance(groupCode);
  modal.classList.remove('show');
  document.querySelector('.modal-content').classList.remove('show');
});

// --- Back button ---
backBtn.addEventListener('click',()=>{
  moduleDetailsDiv.classList.add('hidden');
  modulesContainer.classList.remove('hidden');
});

// --- Sidebar toggle ---
document.getElementById('menu-toggle').addEventListener('click',()=>document.querySelector('.sidebar').classList.toggle('collapsed'));

// Initial render
renderModules();
</script>


</body>
</html>
