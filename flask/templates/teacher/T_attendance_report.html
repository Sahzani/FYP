<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>iAttend - Attendance Report</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">

  <style>
    .main-content {
      margin-left: 260px;
      padding: 100px 30px 30px;
      min-height: 100vh;
      overflow-y: auto;
      transition: margin-left 0.3s ease;
      background: transparent;
    }
    .main-content.expanded {
      margin-left: 80px;
    }

    h2 { font-size: 24px; font-weight: 500; color: #444; margin-bottom: 10px; }

    .card {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(0,0,0,0.15);
    }

    #attendance-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    #attendance-table thead th {
      position: sticky;
      top: 0;
      background: #f8f1e5;
      z-index: 10;
      padding: 12px;
      font-weight: 600;
      color: #2C2C2C;
    }

    #attendance-table thead th:first-child { border-top-left-radius: 12px; }
    #attendance-table thead th:last-child { border-top-right-radius: 12px; }

    #attendance-table tbody td {
      border-top: 1px solid #ddd;
      padding: 12px;
    }

    #attendance-table tbody tr:hover { background: #fef9f0; transition: background 0.2s; }

    .status-badge {
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 6px;
      display: inline-block;
      min-width: 70px;
      text-align: center;
    }
    .status-Present { background-color: #d1fae5; color: green; }
    .status-Late { background-color: #fff7d1; color: orange; }
    .status-Absent { background-color: #fee2e2; color: red; }

    @media (max-width: 768px) {
      .sidebar { left: -260px; }
      .sidebar.collapsed { left: 0; width: 250px; }
      .main-content { margin-left: 0; }
      .main-content.expanded { margin-left: 0; }
    }

    select {
      min-width: 140px;
      white-space: nowrap;
    }

    /* Loading spinner */
    .hidden {
      display: none;
    }
  </style>
</head>

<body>
  <header>
    <span id="menu-toggle">&#9776;</span>
    <div class="header-content">
      <a href="{{ url_for('teacher_dashboard') }}" class="title">iAttend</a>
      <a href="{{ url_for('teacher_profile') }}" class="user-info">
        <span>{{ profile.firstName }} {{ profile.lastName }}</span>
        <img src="{% if profile.photo_name.startswith('http') %}{{ profile.photo_name }}{% else %}{{ url_for('static', filename=profile.photo_name) }}{% endif %}" alt="Teacher Profile">
      </a>
    </div>
  </header>

  <div class="sidebar">
    <div class="sidebar-section">
      <a class="sidebar-link {% if request.endpoint == 'teacher_dashboard' %}active{% endif %}" href="{{ url_for('teacher_dashboard') }}">
        <i class="fas fa-home"></i><span>Dashboard</span>
      </a>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-section-title">Reports</div>
      <a class="sidebar-link {% if request.endpoint == 'teacher_attendance' %}active{% endif %}" href="{{ url_for('teacher_attendance') }}">
        <i class="fas fa-chart-bar"></i><span>Live Attendance</span>
      </a>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-section-title">Manage</div>
      <a class="sidebar-link" href="{{ url_for('teacher_schedules') }}"><i class="fas fa-calendar"></i><span>Class Schedule</span></a>
      <a class="sidebar-link" href="{{ url_for('teacher_modules') }}"><i class="fas fa-book"></i><span>My Modules & Groups</span></a>
      <a class="sidebar-link" href="{{ url_for('teacher_manage_absent') }}"><i class="fas fa-calendar-alt"></i><span>Absences Application</span></a>
      <a class="sidebar-link" href="{{ url_for('teacher_individual_summary') }}"><i class="fas fa-address-card"></i><span>Individual Attendance</span></a>
    </div>

    {% if profile.is_gc %}
    <div class="sidebar-section">
      <div class="sidebar-section-title">Group Coordinator</div>
      <a class="sidebar-link" href="{{ url_for('gc_manage_group') }}"><i class="fas fa-users-cog"></i><span>Manage Group</span></a>
      <a class="sidebar-link" href="{{ url_for('gc_group_report') }}"><i class="fas fa-file-alt"></i><span>Group Report</span></a>
    </div>
    {% endif %}

    <div class="sidebar-section">
      <a class="sidebar-link" href="{{ url_for('teacher_logout') }}"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
    </div>
  </div>

  <div class="main-content">
    <div class="card">
      <h2>Select Class</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Program</label>
          <select id="filter-program" class="w-full border rounded-md p-2">
            <option value="">All Programs</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Group</label>
          <select id="filter-group" class="w-full border rounded-md p-2" disabled>
            <option value="">All Groups</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Module</label>
          <select id="filter-module" class="w-full border rounded-md p-2" disabled>
            <option value="">All Modules</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Day</label>
          <select id="filter-day" class="w-full border rounded-md p-2" disabled>
            <option value="">All Days</option>
          </select>
        </div>
      </div>
      <div class="mt-4">
        <button type="button" id="apply-filters" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Apply Filters</button>
        <button type="button" id="reset-filters" class="ml-2 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg">Reset</button>
      </div>
    </div>

    <div class="card" id="video-container" style="display: none;">
      <h2>Live Camera</h2>
      <div class="flex justify-center">
        <img id="webcam-feed" src="" alt="Camera Feed" class="rounded-md border max-w-md w-full" />
      </div>
      <button id="stopCamera" class="px-4 py-2 bg-red-600 text-white rounded-lg mt-3">Stop Camera</button>
    </div>

    <div class="card">
      <h2>Attendance Table</h2>
      <div id="loading" class="text-center py-4 hidden">
        <div class="inline-block w-6 h-6 border-4 border-t-blue-600 border-solid rounded-full animate-spin"></div>
        <p class="mt-2 text-gray-600">Loading attendance data...</p>
      </div>
      <div class="overflow-x-auto">
        <table id="attendance-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Time</th>
              <th>Status</th>
              <!-- Group column HIDDEN -->
              <th>Program</th>
              <th>Module</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const menuToggle = document.getElementById('menu-toggle');
    const sidebar = document.querySelector('.sidebar');
    const mainContent = document.querySelector('.main-content');

    menuToggle.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      mainContent.classList.toggle('expanded');
    });

    const WEBCAM_URL = "{{ webcam_url }}";
    let allSchedules = [];
    let scheduleId = "";
    const videoContainer = document.getElementById('video-container');
    const webcamFeed = document.getElementById('webcam-feed');
    const attendanceTable = document.querySelector('#attendance-table tbody');
    const loadingIndicator = document.getElementById('loading');
    let refreshInterval = null;

    // === FETCH SCHEDULES VIA AJAX ===
    function loadSchedules() {
      fetch('/api/schedules')
        .then(res => {
          if (!res.ok) throw new Error('Failed to load schedules');
          return res.json();
        })
        .then(data => {
          allSchedules = data.map(s => ({
            ...s,
            programName: (s.programName || '').trim(),
            groupName: (s.groupName || '').trim(),
            moduleName: (s.moduleName || '').trim(),
            day: (s.day || '').trim()
          }));

          const programSelect = document.getElementById('filter-program');
          programSelect.innerHTML = '<option value="">All Programs</option>';
          const uniquePrograms = [...new Set(allSchedules.map(s => s.programName))]
            .filter(name => name && name !== "-")
            .sort();
          uniquePrograms.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            programSelect.appendChild(option);
          });
          updateFilters();
        })
        .catch(err => {
          console.error("Error loading schedules:", err);
          alert("Failed to load class data. Please refresh the page.");
        });
    }

    function populateDropdown(id, values) {
      const select = document.getElementById(id);
      const current = select.value;
      select.innerHTML = '<option value="">All</option>';
      const uniqueValues = [...new Set(values)]
        .filter(v => v && v.trim() !== "")
        .sort();
      uniqueValues.forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val;
        select.appendChild(opt);
      });
      if (uniqueValues.includes(current)) select.value = current;
      else select.value = "";
    }

    function updateFilters() {
      const program = document.getElementById('filter-program').value;
      const group = document.getElementById('filter-group').value;
      const module = document.getElementById('filter-module').value;
      const day = document.getElementById('filter-day').value;
      let filtered = allSchedules;
      if (program) filtered = filtered.filter(s => s.programName === program);
      if (group) filtered = filtered.filter(s => s.groupName === group);
      if (module) filtered = filtered.filter(s => s.moduleName === module);
      if (day) filtered = filtered.filter(s => s.day === day);
      populateDropdown('filter-group', filtered.map(s => s.groupName));
      populateDropdown('filter-module', filtered.map(s => s.moduleName));
      populateDropdown('filter-day', filtered.map(s => s.day));
      document.getElementById('filter-group').disabled = !filtered.some(s => s.groupName);
      document.getElementById('filter-module').disabled = !filtered.some(s => s.moduleName);
      document.getElementById('filter-day').disabled = !filtered.some(s => s.day);
      window.filteredSchedules = filtered;
    }

    document.getElementById('filter-program').addEventListener('change', updateFilters);
    document.getElementById('filter-group').addEventListener('change', updateFilters);
    document.getElementById('filter-module').addEventListener('change', updateFilters);
    document.getElementById('filter-day').addEventListener('change', updateFilters);

    document.getElementById('apply-filters').addEventListener('click', () => {
      const filtered = window.filteredSchedules || allSchedules;
      if (filtered.length === 0) {
        alert("No classes match your filters.");
        return;
      }
      if (filtered.length === 1) {
        scheduleId = filtered[0].docId;

        // Show loading
        loadingIndicator.classList.remove('hidden');
        attendanceTable.innerHTML = '';

        startCameraWithSchedule(scheduleId);
      } else {
        alert("Multiple classes match. Please refine filters.");
      }
    });

    document.getElementById('reset-filters').addEventListener('click', () => {
      document.getElementById('filter-program').value = '';
      document.getElementById('filter-group').value = '';
      document.getElementById('filter-module').value = '';
      document.getElementById('filter-day').value = '';
      updateFilters();
    });

    document.getElementById('stopCamera').addEventListener('click', () => {
      if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
      }

      videoContainer.style.display = "none";
      webcamFeed.src = "";

      if (scheduleId) {
        fetch("/api/mark_absent_on_stop", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ schedule_id: scheduleId })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert(`Camera stopped. ${data.absent_marked} students marked as Absent.`);
            fetchAttendance(scheduleId);
          }
        })
        .catch(err => {
          console.error("Failed to mark absent students:", err);
          alert("Camera stopped, but failed to update attendance.");
        });
      }
    });

    function startCameraWithSchedule(scheduleId) {
      fetch(`${WEBCAM_URL}/start_camera`, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `schedule=${encodeURIComponent(scheduleId)}`
      })
      .then(() => {
        videoContainer.style.display = "block";
        webcamFeed.src = `${WEBCAM_URL}/video_feed`;

        fetchAttendance(scheduleId);

        if (refreshInterval) clearInterval(refreshInterval);
        refreshInterval = setInterval(() => {
          fetchAttendance(scheduleId);
        }, 2000);
      })
      .catch(err => console.error("Failed to start camera:", err));
    }

    function fetchAttendance(scheduleId) {
      fetch(`/api/attendance/${scheduleId}`)
        .then(res => res.json())
        .then(data => {
          // Hide loading
          loadingIndicator.classList.add('hidden');

          if (!data.students || data.students.length === 0) {
            attendanceTable.innerHTML = `<tr><td colspan="6" class="text-center py-4">No students found</td></tr>`;
            return;
          }

          const currentStudents = {};
          attendanceTable.querySelectorAll('tr').forEach(tr => {
            const email = tr.querySelector('td:nth-child(2)').textContent;
            currentStudents[email] = tr;
          });

          data.students.forEach(student => {
            const moduleName = student.module && student.module !== "-" ? student.module : "Unknown Module";

            if (currentStudents[student.email]) {
              const tr = currentStudents[student.email];
              tr.querySelector('td:nth-child(3)').textContent = student.time || "-";
              const statusSpan = tr.querySelector('td:nth-child(4) span');
              statusSpan.textContent = student.status;
              statusSpan.className = `status-badge status-${student.status}`;
            } else {
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${student.name || "Unknown Student"}</td>
                <td>${student.email || "-"}</td>
                <td>${student.time || "-"}</td>
                <td><span class="status-badge status-${student.status}">${student.status}</span></td>
                <td>${student.program || "-"}</td>
                <td>${moduleName}</td>
              `;
              attendanceTable.appendChild(tr);
            }
          });
        })
        .catch(err => {
          console.error("Failed to fetch attendance:", err);
          loadingIndicator.classList.add('hidden');
          attendanceTable.innerHTML = `<tr><td colspan="6" class="text-center py-4">Error loading data</td></tr>`;
        });
    }

    document.addEventListener('DOMContentLoaded', loadSchedules);
  </script>
</body>
</html>