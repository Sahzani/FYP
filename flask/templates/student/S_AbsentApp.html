<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>iAttend Student Absence Application</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />

<style>
/* Reset & Body - Matched to S_Dashboard */
* { margin:0; padding:0; box-sizing:border-box; }
html, body { height:100%; font-family:'Poppins',sans-serif; background: linear-gradient(180deg,#f7ecd7 0%,#f8f1e5 35%,#fbfaf7 100%); overflow-x:hidden; }

/* Header - Matched to S_Dashboard */
header { position:fixed; top:0; left:0; right:0; height:60px; background:#fff; box-shadow:0 6px 20px rgba(0,0,0,0.08); display:flex; align-items:center; padding:0 20px; z-index:1000; }
#menu-toggle { font-size:28px; margin-right:15px; cursor:pointer; transition: color 0.3s; }
#menu-toggle:hover { color:#4154F1; }
.header-content { display:flex; justify-content:space-between; align-items:center; width:100%; }
.header-content a.title { text-decoration:none; color:#444; font-weight:700; font-size:26px; transition: color 0.3s; }
.header-content a.title:hover { color:#4154F1; }
header a.user-info { display:flex; align-items:center; gap:10px; text-decoration:none; color:#444; font-weight:600; transition:all 0.2s ease; padding:0; border-radius:0; background:transparent; box-shadow:none; }
header a.user-info:hover { padding:4px 12px; border-radius:12px; background:#f8f1e5; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
header a.user-info img { width:36px; height:36px; border-radius:50%; object-fit:cover; }

/* Sidebar - Matched to S_Dashboard */
.sidebar {
    position: fixed;
    top: 60px;
    left: 0;
    width: 250px;
    height: calc(100% - 60px);
    background: #f8f1e5;
    padding: 15px 0;
    box-shadow: 2px 0 15px rgba(0,0,0,0.08);
    border-top-right-radius: 12px;
    transition: all 0.3s ease;
    overflow-y: auto;
    z-index: 999;
}
.sidebar-section { margin-bottom: 25px; padding:0 15px; }
.sidebar-section-title { font-size:11px; text-transform:uppercase; letter-spacing:1px; color:#6b7280; margin-bottom:10px; padding-left:10px; }
.sidebar-link { display:flex; align-items:center; gap:10px; padding:12px 15px; margin-bottom:8px; border-radius:8px; font-size:15px; font-weight:500; color:#2C2C2C; text-decoration:none; transition: all 0.25s ease; white-space:nowrap; }
.sidebar-link i { width:18px; text-align:center; }
.sidebar-link.active, .sidebar-link:hover { background:#eadbbf; color:#1F2937; font-weight:600; }

/* Collapsed Sidebar - Matched to S_Dashboard */
.sidebar.collapsed { width:70px; overflow:hidden; }
.sidebar.collapsed .sidebar-section-title, .sidebar.collapsed .sidebar-link span { display:none; }

/* Main Content - Matched to S_Dashboard */
.main-content { margin-left:260px; padding:100px 30px 30px; min-height:100vh; overflow-y:auto; transition:margin-left 0.3s ease; }
.main-content.expanded { margin-left:80px; }

/* Page Title & Breadcrumb */
.page-title { font-family:'Poppins',sans-serif; font-size:36px; font-weight:700; color:#444; margin-bottom:10px; }
.breadcrumb { font-family:'Poppins',sans-serif; font-size:14px; font-weight:500; margin-bottom:30px; color:#666; }
.breadcrumb .section { color:#989797; }
.breadcrumb .current { color:#4154F1; font-weight:600;}

/* Card & Button - Matched to S_Dashboard card style */
.card { background:#fff; padding:30px; border-radius:15px; box-shadow:0 15px 30px rgba(0,0,0,0.05); position:relative; margin-bottom:25px; transition: transform 0.3s, box-shadow 0.3s; }
.card:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
.send-application-btn {
    position:absolute; top:-50px; right:2px;
    background:#4154F1;
    color:#fff; font-size:14px; font-weight:600;
    padding:10px 18px;
    border-radius:8px; border:none; cursor:pointer;
    box-shadow:0 4px 12px rgba(65, 84, 241, 0.3);
    text-decoration:none; transition: all 0.25s ease;
}
.send-application-btn:hover {
    background:#3a4cd0;
    transform:translateY(-2px);
    box-shadow:0 6px 16px rgba(65, 84, 241, 0.4);
}

/* --- NEW: Table format from user's example --- */
.table-scroll { overflow-x: auto; }
table { width: 100%; border-collapse: separate; border-spacing: 0; table-layout: fixed; text-align: center; }
thead th { font-weight: 600; font-size: 14px; color: #2C2C2C; background-color: #f8f1e5; padding: 12px; text-align: center; position: sticky; top: 0; z-index: 10; }
thead th:first-child { border-top-left-radius: 12px; }
thead th:last-child { border-top-right-radius: 12px; }
tbody td { padding: 12px 8px; border-top: 1px solid #e0e0e0; word-wrap: break-word; text-align: center; }
tbody tr:hover { background: #fef9f0; transition: background 0.2s; }

/* --- NEW: Status styling adapted from user's example --- */
td.status-approved { color:#16a34a; font-weight:600; }
td.status-rejected { color:#dc2626; font-weight:600; }
td.status-in-progress { color:#4154F1; font-weight:600; }

/* Icon Buttons (Edit / Delete) */
.icon-btn {border: none; background: none; cursor: pointer; font-size: 18px; margin-right: 10px; transition: all 0.25s ease; vertical-align: middle;}
.icon-btn i {transition: transform 0.25s ease, color 0.25s ease, text-shadow 0.25s ease;}
.icon-btn.edit {color: #4154F1;}
.icon-btn.edit:hover {transform: scale(1.2); text-shadow: 0 0 8px rgba(65, 84, 241, 0.5);}
.icon-btn.delete {color: #dc3545;}
.icon-btn.delete:hover {transform: scale(1.2); text-shadow: 0 0 8px rgba(220, 53, 69, 0.5);}

/* Modal - Matched to S_Dashboard theme */
.modal { display:none; position:fixed; z-index:10000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; transition:opacity 0.3s; }
.modal.show { display:flex; opacity:1; }
.modal-content { background:#fff; margin:auto; padding:0; border-radius:12px; width:90%; max-width:450px; overflow:hidden; transform:translateY(-50px); transition: transform 0.3s; }
.modal.show .modal-content { transform:translateY(0); }
.modal-header { background:#4154F1; padding:15px; color:#fff; font-size:20px; font-weight:600; display:flex; justify-content:space-between; align-items:center; }
.modal label { display:block; margin:10px 0 5px; color:#444; font-weight:600; }
.modal input { width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; font-size:14px; margin-bottom:12px; transition:border-color 0.2s; }
.modal input:focus { border-color:#4154F1; outline:none; }
.modal-buttons { text-align:right; margin-top:10px; }
.modal button { padding:10px 16px; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:14px; margin-left:10px; transition:opacity 0.2s, transform 0.2s; }
.modal .save-btn { background:#4154F1; color:#fff; }
.modal .save-btn:hover { opacity:0.9; transform:translateY(-1px); }
.modal .cancel-btn { background:#eee; color:#444; }
.modal .cancel-btn:hover { opacity:0.8; transform:translateY(-1px); }

/* Responsive */
@media(max-width:768px) {
    .sidebar{left:-250px;}
    .sidebar.show{left:0;}
    .main-content{margin-left:0!important;padding:80px 15px 15px;}
    header a.title{font-size:20px;}
    .page-title{font-size:28px;}
    .send-application-btn{top:10px; right:10px; font-size:12px; padding:6px 12px;}
    .modal-content{width:95%;}
}
</style>
</head>

<body>
<header>
    <span id="menu-toggle">&#9776;</span>
    <div class="header-content">
        <a href="{{ url_for('student_dashboard') }}" class="title">iAttend</a>
        <a href="{{ url_for('student_profile') }}" class="user-info">
            <span id="header-user-name">{{ full_name or 'Student' }}</span>
            <img id="user-profile-pic-header" src="{{ profile_pic_url or 'https://placehold.co/36x36/899BBD/ffffff?text=P' }}" alt="User Profile">
        </a>
    </div>
</header>

<div class="sidebar">
    <div class="sidebar-section">
        <a class="sidebar-link {% if request.endpoint=='student_dashboard' %}active{% endif %}" href="{{ url_for('student_dashboard') }}">
            <i class="fas fa-home"></i><span>Dashboard</span>
        </a>
    </div>
    <div class="sidebar-section">
        <div class="sidebar-section-title">Academics</div>
        <a class="sidebar-link {% if request.endpoint=='student_schedule' %}active{% endif %}" href="{{ url_for('student_schedule') }}">
            <i class="fas fa-calendar-days"></i><span>My Schedule</span>
        </a>
        <a class="sidebar-link {% if request.endpoint=='student_attendance' %}active{% endif %}" href="{{ url_for('student_attendance') }}">
            <i class="fas fa-clipboard-check"></i><span>Attendance</span>
        </a>
    </div>
    <div class="sidebar-section">
        <div class="sidebar-section-title">Request</div>
        <a class="sidebar-link active" href="{{ url_for('student_absentapp') }}">
            <i class="fas fa-file-alt"></i><span>Absence Application</span>
        </a>
        <a class="sidebar-link {% if request.endpoint=='student_contact' %}active{% endif %}" href="{{ url_for('student_contact') }}">
            <i class="fas fa-envelope"></i><span>Contact Us</span>
        </a>
    </div>
    <div class="sidebar-section">
        <a class="sidebar-link" href="{{ url_for('logout') }}">
            <i class="fas fa-sign-out-alt"></i><span>Logout</span>
        </a>
    </div>
</div>

<div class="main-content">
    <h1 class="page-title">Absence Records</h1>
    <div class="breadcrumb"><span class="section">Request </span> / <span class="current">Absence Records</span></div>

    <div class="card">
        <button id="openApplicationModal" class="send-application-btn">Send application</button>
        <div class="table-scroll">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Reason</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Duration (days)</th>
                        <th>Status</th>
                        <th>File</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="recordsBody">
                    {% if records %}
                      {% for rec in records %}
                        <tr>
                          <td>{{ loop.index }}</td>
                          <td>{{ rec.reason }}</td>
                          <td>{{ rec.start_date }}</td>
                          <td>{{ rec.end_date }}</td>
                          <td>{{ rec.duration_days }}</td>
                          <td class="status-{{ rec.status|lower|replace(' ','-') }}">{{ rec.status }}</td>
                          <td>
                            {% if rec.file_data %}
                                {% if rec.file_type.startswith('image') %}
                                <a href="{{ rec.file_data }}" target="_blank">
                                    <img src="{{ rec.file_data }}" alt="{{ rec.file_name }}" style="max-width:60px; max-height:60px; border-radius:4px;"/>
                                </a>
                                {% else %}
                                <a href="{{ rec.file_data }}" target="_blank">{{ rec.file_name }}</a>
                                {% endif %}
                            {% else %}
                                No file
                            {% endif %}
                          </td>
                          <td>
                            <button class="icon-btn edit" data-id="{{ rec.id }}" data-reason="{{ rec.reason }}" data-start="{{ rec.start_date }}" data-end="{{ rec.end_date }}">
                              <i class="fas fa-pen"></i></button>
                            <form method="POST" action="{{ url_for('delete_absent_record', record_id=rec.id) }}" style="display:inline;">
                              <button type="submit" class="icon-btn delete"><i class="fas fa-trash"></i></button>
                            </form>
                          </td>
                        </tr>
                      {% endfor %}
                    {% else %}
                      <tr>
                        <td colspan="8">No absence records found.</td>
                      </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span>Send Absence Application</span>
            <span class="close" style="cursor:pointer;">&times;</span>
        </div>
        <div class="modal-body">
            <form id="absenceForm" method="POST" action="{{ url_for('student_absentapp') }}" enctype="multipart/form-data">
                <label>Reason</label>
                <input type="text" name="reason" placeholder="Enter reason" required>
                <label>Start Date</label>
                <input type="date" name="start_date" required>
                <label>End Date</label>
                <input type="date" name="end_date" required>
                <label>Upload File (PDF/Image)</label>
                <input type="file" name="file" accept=".pdf,.jpg,.png" required>
                <div class="modal-buttons">
                    <button type="submit" class="save-btn">Send</button>
                    <button type="button" class="cancel-btn" id="cancelBtn">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    const menuToggle = document.getElementById('menu-toggle');
    const sidebar = document.querySelector('.sidebar');
    const mainContent = document.querySelector('.main-content');
    const modal = document.getElementById('editModal');
    const closeBtn = modal.querySelector('.close');
    const cancelBtn = document.getElementById('cancelBtn');
    const openApplicationModal = document.getElementById('openApplicationModal');
    const absenceForm = document.getElementById('absenceForm');

    menuToggle.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        mainContent.classList.toggle('expanded');
    });

    if (window.innerWidth > 768 && sidebar.classList.contains('collapsed')) {
        mainContent.classList.add('expanded');
    }

    function openModal() {
        modal.classList.add('show');
        absenceForm.reset();
        absenceForm.action = "{{ url_for('student_absentapp') }}";
        absenceForm.querySelector(".save-btn").textContent = "Send";
    }
    openApplicationModal.onclick = openModal;

    function attachEditButtons() {
        document.querySelectorAll('.icon-btn.edit').forEach(btn => {
            btn.onclick = () => {
                modal.classList.add('show');
                absenceForm.action = `/student/absentapp/edit/${btn.dataset.id}`;
                absenceForm.querySelector("input[name='reason']").value = btn.dataset.reason;
                absenceForm.querySelector("input[name='start_date']").value = btn.dataset.start;
                absenceForm.querySelector("input[name='end_date']").value = btn.dataset.end;
                absenceForm.querySelector(".save-btn").textContent = "Save Changes";
            };
        });
    }

    attachEditButtons();

    closeBtn.onclick = cancelBtn.onclick = () => modal.classList.remove('show');

    function formatDate(d) {
        const dt = new Date(d);
        const day = String(dt.getDate()).padStart(2,'0');
        const month = String(dt.getMonth()+1).padStart(2,'0');
        const year = dt.getFullYear();
        return `${day}/${month}/${year}`;
    }

    function renderFileCell(rec) {
        if (!rec.file_data) return 'No file';
        if (rec.file_type && rec.file_type.startsWith('image')) {
            return `<a href='${rec.file_data}' target='_blank'><img src='${rec.file_data}' style='max-width:60px; max-height:60px; border-radius:4px'/></a>`;
        } else {
            return `<a href='${rec.file_data}' target='_blank'>${rec.file_name || 'View File'}</a>`;
        }
    }
    
    // UPDATED: JavaScript row generation to match new table format
    function renderTableRows(records) {
        const tbody = document.getElementById('recordsBody');
        tbody.innerHTML = '';
        if (records.length > 0) {
            records.forEach((rec, index) => {
                const tr = document.createElement('tr');
                const statusClass = (rec.status || '').toLowerCase().replace(' ','-');
                tr.innerHTML = `
                    <td>${index+1}</td>
                    <td>${rec.reason}</td>
                    <td>${formatDate(rec.start_date)}</td>
                    <td>${formatDate(rec.end_date)}</td>
                    <td>${rec.duration_days}</td>
                    <td class="status-${statusClass}">${rec.status}</td>
                    <td>${renderFileCell(rec)}</td>
                    <td>
                        <button class='icon-btn edit' data-id='${rec.id}' data-reason='${rec.reason}' data-start='${rec.start_date}' data-end='${rec.end_date}'><i class='fas fa-pen'></i></button>
                        <form method='POST' action='/student/absentapp/delete/${rec.id}' style='display:inline;'><button type='submit' class='icon-btn delete'><i class='fas fa-trash'></i></button></form>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            attachEditButtons();
        } else {
            tbody.innerHTML = `<tr><td colspan='8'>No absence records found.</td></tr>`;
        }
    }

    absenceForm.onsubmit = async function(e) {
        e.preventDefault();
        const formData = new FormData(absenceForm);
        const actionURL = absenceForm.action;

        try {
            const response = await fetch(actionURL, { method:"POST", body: formData });
            if (response.ok) {
                modal.classList.remove("show");
                absenceForm.reset();
                
                const data = await fetch("{{ url_for('student_absentapp') }}?fetch=1").then(res => res.json());
                renderTableRows(data.records);

                const successMessage = actionURL.includes('/edit/') ? "Absence record updated successfully!" : "Absence application sent successfully!";
                alert(successMessage);
            } else {
                alert("Failed to submit application.");
            }
        } catch (err) {
            console.error(err);
            alert("Error submitting the form.");
        }
    };

    setInterval(async () => {
        const data = await fetch("{{ url_for('student_absentapp') }}?fetch=1").then(res => res.json());
        renderTableRows(data.records);
    }, 10000);

</script>
</body>
</html>