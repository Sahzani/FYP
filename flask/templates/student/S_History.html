<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>iAttend Student Attendance History</title>
  <!-- Fixed: Removed extra spaces in CDN URLs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">

  <style>
    /* Main Content */
    .main-content {
      margin-left: 260px; padding: 100px 30px 30px; min-height: 100vh;
      overflow-y: auto; transition: margin-left 0.3s ease; background: transparent;
    }
    .main-content.expanded { margin-left: 80px; }

    /* Page Title */
    .main-content h1 {
      font-family: 'Poppins', sans-serif; font-size: 36px; font-weight: 700; color: #444; margin-bottom: 5px;
    }
    /* Cards */
    .card {
      background: #fff; padding: 22px; border-radius: 15px;
      box-shadow: 0 15px 30px rgba(0,0,0,0.05); margin-bottom: 25px;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .card:hover {
      transform: translateY(-8px); box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    .card h2 {
      font-size:24px; font-weight:500; color:#444; margin-bottom:10px; ;
      border-bottom: none; padding-bottom: 0;
    }

    /* Summary Boxes */
    .summary-box-container {
      display: flex; gap: 20px; align-items: center; flex-wrap: wrap; margin-top: 10px;
    }
    .summary-box {
      display: flex; flex-direction: column; align-items: center; padding: 15px 20px;
      border-radius: 10px; font-weight: 600; text-align: center; min-width: 120px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .summary-box span.value { font-size: 24px; font-weight: 700; margin-top: 5px; }
    .summary-box span.label { font-size: 12px; text-transform: uppercase; color: #6b7280; }

    /* Status Colors */
    .total-box { background: #f3f4f6; color: #1f2937; }
    .present-box { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
    .absent-box { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
    .late-box { background: #fef3c7; color: #b45309; border: 1px solid #fde68a; }
    .percentage-good { background: #e0e7ff; color: #4154F1; border: 1px solid #c7d2fe; }
    .percentage-bad { background: #fef3c7; color: #b45309; border: 1px solid #fde68a; }

    /* Table */
    .table-wrapper { overflow-x: auto; }
    table { width: 100%; border-collapse: separate; border-spacing: 0; table-layout: fixed; text-align: center; }
    table thead th { font-weight: 600; font-size: 14px; color: #2C2C2C; background-color: #f8f1e5; padding: 12px 8px; text-align: center; position: sticky; top: 0; z-index: 10; }
    table thead th:first-child { border-top-left-radius: 12px; }
    table thead th:last-child { border-top-right-radius: 12px; }
    table tbody td { padding: 12px 8px; border-top: 1px solid #ddd; word-wrap: break-word; text-align: center; }
    table tbody tr:hover { background: #fef9f0; transition: background 0.2s; }

    .status-present { color: #065f46; font-weight: 600; }
    .status-absent { color: #991b1b; font-weight: 600; }
    .status-late { color: #b45309; font-weight: 600; } /* amber/darker color for late */

    @media (max-width: 768px) {
      .summary-box { min-width: unset; flex: 1; }
      .filters-row { flex-direction: column; gap: 8px; align-items: stretch; }
    }

    /* Filter elements */
    .filter-input { padding: 6px 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; }
    .filter-btn { padding: 7px 12px; background:#4154F1; color:white; border-radius:8px; border:none; cursor:pointer; }
    .filter-btn:hover { background:#2f43d0; }

    /* Remarks colors */
.remarks-approved {
  color: green;
  font-weight: bold;
}

.remarks-rejected {
  color: red;
  font-weight: bold;
}

.remarks-pending {
  color: blue; /* or yellow if you prefer */
  font-weight: bold;
}

  </style>
</head>
<body>

<header>
  <span id="menu-toggle">&#9776;</span>
  <div class="header-content">
    <a href="{{ url_for('student_dashboard') }}" class="title">iAttend</a>
    <a href="{{ url_for('student_profile') }}" class="user-info">
      <span id="header-user-name">{{ full_name }}</span>
      <img id="user-profile-pic-header"
        src="{% if photo_name and photo_name.startswith('http') %}{{ photo_name }}{% elif photo_name %}{{ url_for('static', filename=photo_name) }}{% else %}https://placehold.co/36x36/899BBD/ffffff?text=P{% endif %}"
        alt="User Profile Picture">
    </a>
  </div>
</header>

<div class="sidebar">
  <div class="sidebar-section">
    <a class="sidebar-link" href="{{ url_for('student_dashboard') }}">
      <i class="fas fa-home"></i><span>Dashboard</span>
    </a>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-section-title">Academics</div>
    <a class="sidebar-link" href="{{ url_for('student_schedule') }}">
      <i class="fas fa-calendar-days"></i><span>My Schedule</span>
    </a>
    <a class="sidebar-link active" href="{{ url_for('student_attendance') }}">
      <i class="fas fa-clipboard-check"></i><span>Attendance</span>
    </a>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-section-title">Request</div>
    <a class="sidebar-link" href="{{ url_for('student_absentapp') }}">
      <i class="fas fa-file-alt"></i><span>Absence Application</span>
    </a>
  </div>

  <div class="sidebar-section">
    <a class="sidebar-link" href="{{ url_for('logout') }}">
      <i class="fas fa-sign-out-alt"></i><span>Logout</span>
    </a>
  </div>
</div>

<div class="main-content">
  <h2 class="text-2xl font-semibold text-gray-800 mb-1">Attendance History</h2>
  <div class="breadcrumb text-sm text-gray-600 mb-4">
    <span class="section">Academics</span> / <span class="current">Attendance</span>
  </div>

  <!-- Overall Attendance Summary -->
  <div class="card">
    <h2>Your Attendance Summary</h2>
    <div class="summary-box-container">
      <div class="summary-box total-box">
        <span class="value">{{ overall_total }}</span>
        <span class="label">Total Attendance</span>
      </div>
      <div class="summary-box present-box">
        <span class="value">{{ overall_present }}</span>
        <span class="label">Present</span>
      </div>
      <div class="summary-box absent-box">
        <span class="value">{{ overall_absent }}</span>
        <span class="label">Absent</span>
      </div>
      <div class="summary-box late-box">
        <span class="value">{{ overall_late }}</span>
        <span class="label">Late</span>
      </div>
      <div class="summary-box {% if overall_percentage >= 75 %}percentage-good{% else %}percentage-bad{% endif %}">
        <span class="value">{{ overall_percentage }}%</span>
        <span class="label">Attendance</span>
      </div>
    </div>
  </div>

  <!-- Monthly Attendance Summary (always unfiltered) -->
  {% if monthly_stats %}
  <div class="card mt-4">
    <h2>Monthly Attendance Summary</h2>
    <div class="table-wrapper mb-4">
      <table class="w-full text-sm text-left">
        <thead>
          <tr>
            <th>Month</th>
            <th>Total</th>
            <th>Present</th>
            <th>Absent</th>
            <th>Late</th>
            <th>Attendance %</th>
            <th>Chart</th>
          </tr>
        </thead>
        <tbody>
          {% for month, stats in monthly_stats.items()|sort(reverse=True) %}
          {% set y, m = month.split('-') %}
          <tr>
            <td>{{ "%02d"|format(m|int) }} / {{ y }}</td>
            <td>{{ stats.total }}</td>
            <td>{{ stats.present }}</td>
            <td>{{ stats.absent }}</td>
            <td>{{ stats.late }}</td>
            <td>
              {% if stats.total > 0 %}
                {{ ((stats.present / stats.total) * 100)|round(2) }}%
              {% else %}
                0%
              {% endif %}
            </td>
            <td>
              <button class="view-chart-btn px-2 py-1 bg-blue-500 text-white rounded" data-month="{{ month }}">View Chart</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Chart Container -->
    <div id="chartContainer" style="display:none; margin-top:20px;">
      <canvas id="monthlyChart" height="150"></canvas>
      <button id="closeChartBtn" class="mt-2 px-3 py-1 bg-gray-200 rounded">Close Chart</button>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const monthlyStats = {{ monthly_stats | tojson }};
      const chartContainer = document.getElementById("chartContainer");
      const ctx = document.getElementById('monthlyChart').getContext('2d');
      let currentChart = null;

      document.querySelectorAll(".view-chart-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const month = btn.dataset.month;
          const stats = monthlyStats[month];

          chartContainer.style.display = "block";
          if(currentChart) currentChart.destroy();

          currentChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: ['Present', 'Absent', 'Late'],
              datasets: [{
                label: `Attendance for ${month}`,
                data: [stats.present, stats.absent, stats.late],
                backgroundColor: ['#4CAF50','#F44336','#FFC107']
              }]
            },
            options: {
              responsive: true,
              plugins: { legend: { position: 'top' } },
              scales: { y: { beginAtZero: true, precision:0 } }
            }
          });
        });
      });

      document.getElementById("closeChartBtn").addEventListener("click", () => {
        chartContainer.style.display = "none";
      });
    </script>
  </div>
  {% endif %}

  <!-- Overall Attendance by Module -->
  {% if module_stats %}
  <div class="card mt-4">
    <h2>Overall Attendance by Module</h2>
    <div class="table-wrapper">
      <table class="w-full text-sm text-left">
        <thead>
          <tr>
            <th>Module</th>
            <th>Present</th>
            <th>Absent</th>
            <th>Late</th>
            <th>Attendance %</th>
          </tr>
        </thead>
        <tbody>
          {% for module, stats in module_stats.items() %}
          <tr>
            <td>{{ module }}</td>
            <td>{{ stats.present }}</td>
            <td>{{ stats.absent }}</td>
            <td>{{ stats.late }}</td>
            <td>
              {% set total = stats.present + stats.absent + stats.late %}
              {% if total > 0 %}
                {{ ((stats.present / total) * 100)|round(2) }}%
              {% else %}
                0%
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  <!-- Filters & Records Table -->
  <div class="card mt-4">
    <form method="get" class="flex justify-between items-center mb-4 filters-row" style="gap:12px;">
      <h2 class="text-lg font-semibold text-gray-700 m-0">Attendance Records</h2>
      <div class="flex items-center space-x-2">
        <label for="moduleFilter" class="text-sm text-gray-700 font-medium">Module:</label>
        <select name="moduleFilter" id="moduleFilter" class="filter-input">
          <option value="All" {% if selected_module == "All" %}selected{% endif %}>All</option>
          {% for mod in modules %}
            <option value="{{ mod }}" {% if selected_module == mod %}selected{% endif %}>{{ mod }}</option>
          {% endfor %}
        </select>

        <label for="statusFilter" class="text-sm text-gray-700 font-medium">Status:</label>
        <select name="statusFilter" id="statusFilter" class="filter-input">
          <option value="All" {% if selected_status == "All" %}selected{% endif %}>All</option>
          <option value="Present" {% if selected_status == "Present" %}selected{% endif %}>Present</option>
          <option value="Absent" {% if selected_status == "Absent" %}selected{% endif %}>Absent</option>
          <option value="Late" {% if selected_status == "Late" %}selected{% endif %}>Late</option>
        </select>

        <label for="dateFilter" class="text-sm text-gray-700 font-medium">Date:</label>
        <input type="date" name="dateFilter" id="dateFilter" value="{{ date_for_input }}">

        <button type="submit" class="filter-btn flex items-center justify-center gap-1">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
          View
        </button>
      </div>
    </form>

    <div class="table-wrapper">
  <table id="attendanceTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Time</th>
        <th>Module</th>
        <th>Status</th>
        <th>Remarks</th>
      </tr>
    </thead>
    <tbody>
      {% if records %}
        {% for record in records|sort(attribute='_datetime', reverse=True) %}
          {% set remarks = record.remarks if record.remarks else '-' %}
          {% set display_status = record.status %}
          {% if 'Approved' in remarks %}
            {% set display_status = 'Present' %}
          {% elif 'Rejected' in remarks %}
            {% set display_status = 'Absent' %}
          {% elif 'In Progress' in remarks %}
            {% set display_status = 'Absent' %}
          {% endif %}
          <tr>
            <td>{{ record.date }}</td>
            <td>{{ record.time or '-' }}</td>
            <td>{{ record.module or '-' }}</td>
            <td class="{% if display_status == 'Present' %}status-present{% elif display_status == 'Late' %}status-late{% elif display_status == 'Pending' %}status-pending{% else %}status-absent{% endif %}">
              {{ display_status }}
            </td>
            <!-- Colored Remarks using keyword matching -->
            <td class="
              {% if 'Approved' in remarks %}remarks-approved
              {% elif 'Rejected' in remarks %}remarks-rejected
              {% elif 'In Progress' in remarks %}remarks-pending
              {% endif %}
            ">
              {{ remarks }}
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="5" style="text-align:center;">No attendance records found</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>





<!-- Sidebar toggle -->
<script>
  document.getElementById('menu-toggle').addEventListener('click', () => {
    document.querySelector('.sidebar').classList.toggle('collapsed');
    document.querySelector('.main-content').classList.toggle('expanded');
  });
</script>



</body>
</html>
